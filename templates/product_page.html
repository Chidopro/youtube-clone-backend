<!DOCTYPE html>
<html>
<head>
  <title>Customize Your Product</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; text-align: center; padding: 0; margin: 0; }
    h1 { color: #3f51b5; }
    
    /* User Flow Section Styles - Matching Home Page */
    .user-flow-section {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 20px 20px;
      color: white;
      text-align: center;
    }

    .flow-steps {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: nowrap;
      gap: 12px;
      max-width: 800px;
      margin: 0 auto;
    }

    .flow-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      min-width: 130px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .flow-step:hover {
      transform: scale(1.05);
    }

    .step-number {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      font-weight: bold;
      margin-bottom: 6px;
      transition: all 0.3s ease;
    }

    .flow-step:hover .step-number {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }

    .step-content h3 {
      margin: 0 0 3px 0;
      font-size: 0.9rem;
      font-weight: 600;
      color: white;
    }

    .step-content p {
      margin: 0;
      font-size: 0.7rem;
      opacity: 0.9;
      line-height: 1.1;
    }

    .flow-arrow {
      font-size: 1.3rem;
      color: rgba(255, 255, 255, 0.7);
      font-weight: bold;
      margin: 0 6px;
    }

    /* Main Layout Container */
    .main-container {
      display: flex;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      gap: 20px;
    }

    /* Left Column - Video Viewer */
    .video-viewer {
      flex: 1;
      min-width: 300px;
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    /* Middle Column - Screenshots */
    .screenshots-section {
      flex: 1;
      min-width: 300px;
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    /* Right Column - Products */
    .products-section {
      flex: 1;
      min-width: 300px;
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      max-height: 80vh;
      overflow-y: auto;
    }

    .preview-image {
      max-width: 100%;
      width: 100%;
      height: auto;
      margin-bottom: 10px;
      border-radius: 10px;
      cursor: pointer;
      box-sizing: border-box;
      display: block;
    }
    .screenshot-preview-row { 
      display: grid; 
      grid-template-columns: repeat(3, 1fr);
      gap: 10px; 
      margin: 10px 0 30px 0;
    }
    .screenshot-preview-row img {
      width: 100%;
      height: auto;
      border-radius: 4px;
      border: 2px solid #ccc;
      object-fit: cover;
      cursor: pointer;
      box-sizing: border-box;
    }
    .selected-image {
      border: 4px solid #4CAF50 !important;
      box-shadow: 0 0 8px #4CAF50;
      box-sizing: border-box;
    }
    .product-row { 
      display: grid; 
      grid-template-columns: repeat(3, 1fr); 
      gap: 15px; 
      margin-top: 20px; 
      justify-items: center;
    }
    .product-card { background: #fff; padding: 15px; border-radius: 8px; width: 100%; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #eee; }
    .product-card img { width: 100%; height: auto; border-radius: 6px; margin-bottom: 10px; }
    .product-title { font-weight: bold; margin: 10px 0 5px; font-size: 14px; }
    .product-price { color: #444; margin-bottom: 10px; font-size: 12px; }
    .note-input { width: 100%; padding: 6px; margin-bottom: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; }
    .variant-selector { margin-bottom: 12px; background: #f0f4ff; border: 1px solid #bfcfff; border-radius: 6px; padding: 10px; }
    .variant-selector label { display: block; text-align: left; margin-bottom: 4px; color: #3f51b5; font-weight: bold; font-size: 12px; }
    .variant-selector select { width: 100%; padding: 6px; border: 1.5px solid #3f51b5; border-radius: 4px; background: #fff; font-size: 12px; }
    .btn { background: #3f51b5; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .btn:hover { background: #2c3cb5; }
    
    /* Remove the old cart sidebar */
    #cart-sidebar { 
      display: none;
    }
    
    /* Mobile Responsive */
    @media (max-width: 768px) {
      .main-container {
        flex-direction: column;
        padding: 10px;
      }
      
      .flow-steps {
        flex-direction: column;
        gap: 8px;
      }
      
      .flow-arrow {
        transform: rotate(90deg);
        margin: 4px 0;
      }
      
      .flow-step {
        min-width: 110px;
      }
      
      .user-flow-section {
        padding: 15px 15px;
      }
    }

    /* Product Header Styles */
    .product-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 20px;
      margin-bottom: 20px;
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-title {
      font-size: 1.5rem;
      font-weight: bold;
      color: white;
    }

    .header-info {
      display: flex;
      gap: 20px;
      align-items: center;
    }

    .info-item {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 10px;
        text-align: center;
      }
      
      .header-info {
        flex-direction: column;
        gap: 5px;
      }
    }
  </style>
</head>
<body>
  <!-- User Flow Section -->
  <div class="user-flow-section">
    <div class="flow-steps">
      <div class="flow-step" onclick="scrollToScreenshots()">
        <div class="step-number">2</div>
        <div class="step-content">
          <h3>Pick Screenshot</h3>
          <p>Select the perfect moment to capture</p>
        </div>
      </div>
      <div class="flow-arrow">‚Üí</div>
      <div class="flow-step" onclick="scrollToProducts()">
        <div class="step-number">3</div>
        <div class="step-content">
          <h3>Make Merchandise</h3>
          <p>Create custom products with your screenshot</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Header Section -->
  <div class="product-header">
    <div class="header-content">
      <div class="header-logo">
        <img src="/static/icons/screenmerch_logo.png" alt="ScreenMerch Logo" style="width: 40px; height: auto;">
        <span class="header-title">ScreenMerch</span>
      </div>
      <div class="header-info">
        <div class="info-item">üåç Available Worldwide</div>
        <div class="info-item">üì¶ US/Mexico Fulfillment</div>
        <div class="info-item">‚è±Ô∏è 7-14 Day Delivery</div>
      </div>
    </div>
  </div>

  <!-- Main Layout -->
  <div class="main-container">
    <!-- Left Column - Video Viewer -->
    <div class="video-viewer">
      <h3>Video Preview</h3>
      <img id="thumbnailImage" class="preview-image" alt="Selected Thumbnail">
    </div>

    <!-- Middle Column - Screenshots -->
    <div class="screenshots-section" id="screenshotsSection">
      <h3>Screenshot Selection</h3>
      <div class="screenshot-preview-row" id="screenshotPreviewRow"></div>
      <div id="resolutionNotice" class="resolution-notice">
        <strong>Notice:</strong> Maximum resolution is not available. Please select a lower resolution option from the thumbnails below.
      </div>
    </div>

    <!-- Right Column - Products -->
    <div class="products-section" id="productsSection">
      <h3>Available Products</h3>
      <div class="product-row" id="productRow"></div>
    </div>
  </div>

  <script>
    // JavaScript functions for clickable flow steps
    function scrollToScreenshots() {
      document.getElementById('screenshotsSection').scrollIntoView({ 
        behavior: 'smooth',
        block: 'start'
      });
    }

    function scrollToProducts() {
      document.getElementById('productsSection').scrollIntoView({ 
        behavior: 'smooth',
        block: 'start'
      });
    }

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      // Set the thumbnail image
      const thumbnailImage = document.getElementById('thumbnailImage');
      const img = '{{ img_url }}';
      if (img) {
        thumbnailImage.src = img;
      }

      // Populate screenshots
      const screenshots = [];
      {% if screenshots %}
        {% for screenshot in screenshots %}
          screenshots.push('{{ screenshot }}');
        {% endfor %}
      {% endif %}

      // Display screenshots
      const row = document.getElementById("screenshotPreviewRow");
      screenshots.forEach(src => {
        const img = document.createElement("img");
        img.src = src;
        img.addEventListener('click', function() {
          setSelectedImage(img, src);
        });
        row.appendChild(img);
      });

      // Populate products
      const products = [];
      {% if products %}
        {% for product in products %}
          products.push({
            name: '{{ product.name }}',
            price: {{ product.price }},
            main_image: '{{ product.main_image }}',
            filename: '{{ product.filename }}',
            options: {{ product.options | tojson }}
          });
        {% endfor %}
      {% endif %}

      // Display products
      const productRow = document.getElementById("productRow");
      products.forEach(product => {
        const productCard = document.createElement("div");
        productCard.className = "product-card";
        productCard.innerHTML = `
          <img src="/static/images/${product.main_image}" alt="${product.name}" style="width:100%;height:180px;object-fit:cover;border-radius:6px;">
          <div class="product-title">${product.name}</div>
          <div class="product-price">$${product.price.toFixed(2)}</div>
          ${product.options.color ? `
            <div style="font-weight:bold; color:#3f51b5; margin-bottom:6px;">Choose Color & Size:</div>
            <div class="variant-selector">
              <label>Color:</label>
              <select class="variant-select color-select">
                ${product.options.color.map(color => `<option value="${color}">${color}</option>`).join('')}
              </select>
            </div>
          ` : ''}
          ${product.options.size ? `
            <div class="variant-selector">
              <label>Size:</label>
              <select class="variant-select size-select">
                ${product.options.size.map(size => `<option value="${size}">${size}</option>`).join('')}
              </select>
            </div>
          ` : ''}
          <textarea class="note-input" placeholder="Add a note (optional)"></textarea>
          <hr style="margin: 8px 0; border: none; border-top: 1px solid #eee;">
          <button class="btn add-to-cart-btn">Add ${product.name} to Cart</button>
        `;
        productRow.appendChild(productCard);
      });

      // Image selection logic
      let selectedImageUrl = null;
      function setSelectedImage(imgEl, src) {
        document.querySelectorAll('.selected-image').forEach(el => el.classList.remove('selected-image'));
        imgEl.classList.add('selected-image');
        selectedImageUrl = src;
      }

      // Set default selected image
      if (screenshots.length > 0) {
        setSelectedImage(row.firstChild, screenshots[0]);
      }
    });

    // Authentication check on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Check if user is already authenticated
      const savedEmail = localStorage.getItem('cartEmail');
      const isAuthenticated = sessionStorage.getItem('authenticated');
      
      if (!savedEmail && !isAuthenticated) {
        // Show authentication modal
        document.getElementById('email-auth-overlay').style.display = 'flex';
        document.getElementById('authenticated-content').style.display = 'none';
      } else {
        // User is authenticated, show content
        document.getElementById('email-auth-overlay').style.display = 'none';
        document.getElementById('authenticated-content').style.display = 'block';
      }
    });

    // --- Auto-crop function ---
    function autoCropImage(url, callback) {
      const img = new Image();
      img.crossOrigin = "Anonymous";
      img.onload = function () {
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const { data, width, height } = imageData;
        let top = 0, bottom = height, left = 0, right = width;
        const isWhiteOrBlack = (r, g, b) =>
          (r > 230 && g > 230 && b > 230) || (r < 25 && g < 25 && b < 25);
        function scanTop() {
          for (let y = 0; y < height; y++) {
            for (let x = 0; x < width; x++) {
              const i = (y * width + x) * 4;
              if (!isWhiteOrBlack(data[i], data[i+1], data[i+2])) {
                top = y;
                return;
              }
            }
          }
        }
        function scanBottom() {
          for (let y = height - 1; y >= 0; y--) {
            for (let x = 0; x < width; x++) {
              const i = (y * width + x) * 4;
              if (!isWhiteOrBlack(data[i], data[i+1], data[i+2])) {
                bottom = y;
                return;
              }
            }
          }
        }
        function scanLeft() {
          for (let x = 0; x < width; x++) {
            for (let y = 0; y < height; y++) {
              const i = (y * width + x) * 4;
              if (!isWhiteOrBlack(data[i], data[i+1], data[i+2])) {
                left = x;
                return;
              }
            }
          }
        }
        function scanRight() {
          for (let x = width - 1; x >= 0; x--) {
            for (let y = 0; y < height; y++) {
              const i = (y * width + x) * 4;
              if (!isWhiteOrBlack(data[i], data[i+1], data[i+2])) {
                right = x;
                return;
              }
            }
          }
        }
        scanTop(); scanBottom(); scanLeft(); scanRight();
        const croppedW = right - left;
        const croppedH = bottom - top;
        const croppedCanvas = document.createElement("canvas");
        croppedCanvas.width = croppedW;
        croppedCanvas.height = croppedH;
        const croppedCtx = croppedCanvas.getContext("2d");
        croppedCtx.drawImage(canvas, left, top, croppedW, croppedH, 0, 0, croppedW, croppedH);
        callback(croppedCanvas.toDataURL());
      };
      img.src = url;
    }
    // --- End auto-crop function ---

    // Get data from template variables or URL parameters (for backwards compatibility)
    const email = '{{ email }}' || new URLSearchParams(window.location.search).get('email') || '';
    const img = '{{ img_url }}' || new URLSearchParams(window.location.search).get('img') || '';
    const screenParam = new URLSearchParams(window.location.search).get('screens');
    const channel = '{{ channel_id }}' || new URLSearchParams(window.location.search).get('channel') || window.location.pathname.split('/')[2];
    const maxResAvailable = new URLSearchParams(window.location.search).get('maxres') !== 'false';
    const resolutionNotice = document.getElementById('resolutionNotice');

    // Show resolution notice if max resolution is not available
    if (!maxResAvailable) {
      resolutionNotice.style.display = 'block';
    }

    // --- Cart reset logic ---
    const lastChannel = localStorage.getItem('lastChannel');
    if (channel && channel !== lastChannel) {
      localStorage.removeItem('cart');
    }
    localStorage.setItem('lastChannel', channel);
    // --- End cart reset logic ---

    // Set and crop the main thumbnail
    const thumbnailImage = document.getElementById("thumbnailImage");
    autoCropImage(img, function(croppedDataUrl) {
      thumbnailImage.src = croppedDataUrl;
    });

    // Add click event to select the thumbnail
    thumbnailImage.addEventListener('click', function() {
      setSelectedImage(thumbnailImage, thumbnailImage.src);
    });

    // Get screenshots from template or URL parameters
    let screenshots = [];
    {% if screenshots %}
      // Use screenshots passed from template
      {% for screenshot in screenshots %}
        screenshots.push('{{ screenshot }}');
      {% endfor %}
    {% else %}
      // Fallback to reading from URL parameters
      for (let i = 1; i <= 5; i++) {
        const url = new URLSearchParams(window.location.search).get(`screen${i}`);
        if (url) screenshots.push(url);
      }
    {% endif %}
    
    console.log("Email:", email);
    console.log("Main image:", img);
    console.log("Screenshots array:", screenshots);

    // Image selection logic
    let selectedImageUrl = null;
    const row = document.getElementById("screenshotPreviewRow");
    row.innerHTML = "";

    function setSelectedImage(imgEl, src) {
      document.querySelectorAll('.selected-image').forEach(el => el.classList.remove('selected-image'));
      imgEl.classList.add('selected-image');
      selectedImageUrl = src;
    }

    // Crop and display screenshots
    screenshots.forEach(src => {
      autoCropImage(src, function(croppedDataUrl) {
        const img = document.createElement("img");
        img.src = croppedDataUrl;
        img.addEventListener('click', function() {
          setSelectedImage(img, croppedDataUrl);
        });
        row.appendChild(img);
        // By default, select the thumbnail
        if (!selectedImageUrl) {
          setSelectedImage(thumbnailImage, thumbnailImage.src);
        }
      });
    });

    // By default, select the thumbnail after it loads
    thumbnailImage.addEventListener('load', function() {
      if (!selectedImageUrl) {
        setSelectedImage(thumbnailImage, thumbnailImage.src);
      }
    });

    const cartItemsContainer = document.getElementById('cart-items');
    let cart = JSON.parse(localStorage.getItem('cart')) || [];

    function updateCartSidebar() {
      cartItemsContainer.innerHTML = '';
      cart.forEach((item, idx) => {
        const div = document.createElement('div');
        div.className = 'cart-item';
        let variantText = '';
        if (item.variants) {
          if (item.variants.color) variantText += `Color: ${item.variants.color}<br>`;
          if (item.variants.size) variantText += `Size: ${item.variants.size}<br>`;
        }
        div.innerHTML = `