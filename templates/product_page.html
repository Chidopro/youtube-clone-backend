<!DOCTYPE html>
<html>
<head>
  <title>🎯 UPDATED v2.1 - Customize Your Product - {{ timestamp }} - {{ cache_buster }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta http-equiv="Last-Modified" content="{{ timestamp }}">
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; text-align: center; padding: 0; margin: 0; }
    h1 { color: #3f51b5; }
    
         /* Simple Logo Header - Bigger Logo, Less Height */
     .simple-header {
       background: white;
       padding: 5px 2%;
       position: relative;
       z-index: 10;
       border-bottom: 1px solid #eee;
     }

    .simple-header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: flex-start;
      align-items: center;
    }

    .simple-logo {
      display: flex;
      align-items: center;
    }

    .simple-logo .logo-img {
      width: 40px;
      height: 40px;
      display: block;
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .menu-icon {
      width: 24px;
      height: 24px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .menu-icon span {
      width: 100%;
      height: 3px;
      background: #333;
      border-radius: 2px;
    }

    .header-logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-img {
      width: 32px;
      height: 32px;
      display: block;
    }

    .logo-text {
      font-size: 1.2rem;
      font-weight: bold;
      color: #333;
    }

    .search-container {
      flex: 1;
      max-width: 500px;
      margin: 0 20px;
      position: relative;
    }

    .search-input {
      width: 500px;
      padding: 12px 18px;
      border: 1px solid #ccc;
      border-radius: 30px;
      font-size: 16px;
      background: transparent;
      outline: 0;
      transition: border-color 0.2s ease;
    }

    .search-input:focus {
      border-color: #065fd4;
    }

    .search-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      color: #666;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .subscribe-btn {
      background: #cc0000;
      color: white;
      border: 1px solid #cc0000;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.2s ease;
    }

    .subscribe-btn:hover {
      background: #a00000;
      transform: translateY(-1px);
    }

    .signin-btn {
      background: #065fd4;
      color: white;
      border: 1px solid #065fd4;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .signin-btn:hover {
      background: #0448a0;
      transform: translateY(-1px);
    }
    
         /* User Flow Section Styles - Matching Home Page */
     .user-flow-section {
       background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
       margin: 0;
       padding: 40px 20px;
       color: white;
       text-align: center;
       display: flex;
       justify-content: space-between;
       align-items: center;
       position: relative;
       width: 100%;
       box-sizing: border-box;
       min-height: 120px;
     }

    .flow-steps {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: nowrap;
      gap: 12px;
      max-width: 800px;
      margin: 0 auto;
    }

    .flow-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      min-width: 130px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .flow-step:hover {
      transform: translateY(-2px);
    }

                   .step-number {
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        font-weight: bold;
        margin-bottom: 6px;
        transition: all 0.3s ease;
      }

    .flow-step:hover .step-number {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }

                   .step-content h3 {
        margin: 0 0 3px 0;
        font-size: 0.9rem;
        font-weight: 600;
        color: white;
      }

      .step-content p {
        margin: 0;
        font-size: 0.7rem;
        opacity: 0.9;
        line-height: 1.1;
      }

    .flow-arrow {
      font-size: 1.3rem;
      color: rgba(255, 255, 255, 0.7);
      font-weight: bold;
      margin: 0 6px;
    }

         /* Shipping Information */
     .shipping-info {
       display: flex;
       gap: 20px;
       align-items: center;
       margin-top: 0;
       position: absolute;
       top: 10px;
       right: 20px;
       z-index: 5;
     }

    .shipping-item {
      display: flex;
      align-items: center;
      gap: 5px;
      color: white;
      font-size: 0.8rem;
    }

    .shipping-icon {
      font-size: 1rem;
    }

    .shipping-text {
      font-weight: 500;
    }

    /* Main Layout Container */
    .main-container {
      display: flex;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      gap: 20px;
    }

    /* Left Column - Two Stacked Windows (Video Preview Removed) */
    .left-column {
      flex: 1;
      min-width: 400px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      max-width: 500px; /* Give more space to products on the right */
      height: 100%; /* Ensure full height */
    }

    /* Screenshots Selected Window */
    .screenshots-selected {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    /* Products Selected Window */
    .products-selected {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      min-height: 150px; /* Ensure minimum height */
      display: flex;
      flex-direction: column;
    }

    /* Right Column - Available Products */
    .products-section {
      flex: 1;
      min-width: 400px;
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .preview-image {
      max-width: 100%;
      width: 100%;
      height: auto;
      margin-bottom: 10px;
      border-radius: 10px;
      cursor: pointer;
      box-sizing: border-box;
      display: block;
    }
         .screenshot-preview-row { 
       display: flex; 
       flex-direction: column;
       gap: 10px; 
       margin: 10px 0 15px 0;
       min-height: 120px; /* Reduced height to make box smaller */
     }
    
         /* Video thumbnail styling - Much smaller size */
     .video-thumbnail {
       width: 100%;
       height: 40px;
       object-fit: cover;
       border-radius: 6px;
       margin-bottom: 4px;
       border: 2px solid #4CAF50;
       cursor: pointer;
     }
    
    /* Screenshot thumbnails container - fits 5 screenshots */
    .screenshot-thumbnails {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-top: 10px;
    }
    
    /* Individual screenshot styling */
    .screenshot-thumbnail {
      width: 100%;
      height: 60px;
      object-fit: cover;
      border-radius: 4px;
      cursor: pointer;
      border: 1px solid #ddd;
      transition: border-color 0.2s;
    }
    
    .screenshot-thumbnail:hover {
      border-color: #4CAF50;
    }
    .screenshot-preview-row img {
      width: 100%;
      height: auto;
      border-radius: 4px;
      border: 2px solid #ccc;
      object-fit: cover;
      cursor: pointer;
      box-sizing: border-box;
    }
    .selected-image {
      border: 4px solid #4CAF50 !important;
      box-shadow: 0 0 8px #4CAF50;
      box-sizing: border-box;
    }
    .product-row { 
      display: grid; 
      grid-template-columns: repeat(3, 1fr); 
      gap: 15px; 
      margin-top: 20px; 
      justify-items: center;
    }
    .product-card { background: #fff; padding: 15px; border-radius: 8px; width: 100%; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #eee; }
    .product-card img { width: 100%; height: auto; border-radius: 6px; margin-bottom: 10px; }
    .product-title { font-weight: bold; margin: 10px 0 5px; font-size: 14px; }
    .product-price { color: #444; margin-bottom: 10px; font-size: 12px; }
    .note-input { width: 100%; padding: 6px; margin-bottom: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; }
    .variant-selector { margin-bottom: 12px; background: #f0f4ff; border: 1px solid #bfcfff; border-radius: 6px; padding: 10px; }
    .variant-selector label { display: block; text-align: left; margin-bottom: 4px; color: #3f51b5; font-weight: bold; font-size: 12px; }
    .variant-selector select { width: 100%; padding: 6px; border: 1.5px solid #3f51b5; border-radius: 4px; background: #fff; font-size: 12px; }
    .btn { background: #3f51b5; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .btn:hover { background: #2c3cb5; }
    
    /* Category Grid Styles */
    .category-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    
    /* Remove the old cart sidebar */
    #cart-sidebar { 
      display: none;
    }
    
         /* Mobile Responsive */
     @media (max-width: 768px) {
       body {
         overflow-x: hidden !important;
         width: 100% !important;
         box-sizing: border-box !important;
       }
       
       .main-container {
         flex-direction: column;
         padding: 10px;
         gap: 15px;
         overflow-x: hidden !important;
         width: 100% !important;
         max-width: 100% !important;
       }
       
       .left-column {
         min-width: auto;
         max-width: 100%;
       }
       
       .right-column {
         min-width: auto;
       }
       
       .screenshots-selected,
       .products-selected,
       .products-section {
         padding: 15px;
         margin-bottom: 15px;
       }
       
       .screenshot-preview-row {
         min-height: 100px;
         margin: 8px 0 10px 0;
       }
       
       .video-thumbnail {
         height: 30px;
         margin-bottom: 3px;
       }
       
       .screenshot-thumbnails {
         grid-template-columns: repeat(2, 1fr);
         gap: 6px;
         margin-top: 8px;
       }
       
       .screenshot-thumbnail {
         height: 50px;
       }
       
       .product-row {
         grid-template-columns: repeat(2, 1fr);
         gap: 12px;
         margin-top: 15px;
       }
       
       .category-grid {
         grid-template-columns: repeat(2, 1fr) !important;
         gap: 15px !important;
         max-width: 100% !important;
       }
       
       .product-card {
         padding: 12px;
       }
       
       .product-card img {
         height: 150px;
       }
       
       .variant-selector {
         padding: 8px;
         margin-bottom: 10px;
       }
       
       .variant-selector label {
         font-size: 11px;
       }
       
       .variant-selector select {
         padding: 5px;
         font-size: 11px;
       }
       
       .note-input {
         padding: 5px;
         font-size: 11px;
         margin-bottom: 10px;
       }
       
       .btn {
         padding: 10px 16px;
         font-size: 14px;
         width: 100%;
       }
       
       .user-flow-section {
         padding: 20px 15px;
         min-height: 100px;
         flex-direction: column;
         gap: 15px;
       }
       
       .flow-steps {
         position: static !important;
         transform: none !important;
         left: auto !important;
         margin: 0 auto;
       }
       
       .shipping-info {
         position: static !important;
         top: auto !important;
         right: auto !important;
         justify-content: center;
         flex-wrap: wrap;
         gap: 10px;
         margin-top: 10px;
       }
       
       .shipping-item {
         font-size: 0.7rem;
         gap: 3px;
       }
       
       .shipping-icon {
         font-size: 0.9rem;
       }
       
       .step-number {
         width: 28px;
         height: 28px;
         font-size: 0.9rem;
       }
       
       .step-content h3 {
         font-size: 0.8rem;
       }
       
       .step-content p {
         font-size: 0.6rem;
       }
       
       /* Touch-friendly interactions */
       .screenshot-thumbnail,
       .video-thumbnail,
       .btn,
       .variant-selector select {
         min-height: 44px;
         touch-action: manipulation;
       }
       
       .screenshot-thumbnail:hover,
       .video-thumbnail:hover {
         transform: scale(1.05);
       }
       
       /* Better spacing for mobile */
       h3 {
         font-size: 1.1rem;
         margin-bottom: 10px;
       }
       
       .selected-products {
         min-height: 60px;
         display: flex;
         align-items: center;
         justify-content: center;
       }
     }
     
     /* Extra small mobile devices */
     @media (max-width: 480px) {
       .main-container {
         padding: 8px;
         gap: 12px;
       }
       
       .screenshots-selected,
       .products-selected,
       .products-section {
         padding: 12px;
       }
       
       .screenshot-thumbnails {
         grid-template-columns: repeat(2, 1fr);
         gap: 4px;
       }
       
       .product-card img {
         height: 120px;
       }
       
       .user-flow-section {
         padding: 15px 10px;
       }
       
       .shipping-info {
         gap: 8px;
       }
       
       .shipping-item {
         font-size: 0.6rem;
       }
     }
  </style>
</head>
<body>
  

     <!-- User Flow Section - Only Step 3 since we're already at merchandise page -->
   <div class="user-flow-section">
           <!-- Make Merchandise Section - Now positioned above Screenshots Selected -->
      <div class="flow-steps" style="position: absolute; left: 25%; transform: translateX(-50%); z-index: 5;">
        <div class="flow-step">
          <div class="step-number">3</div>
          <div class="step-content">
            <h3>Make Merchandise</h3>
            <p>Create custom products with your screenshot</p>
          </div>
        </div>
      </div>
     
     <!-- Shipping Information - Now on the UPPER RIGHT -->
     <div class="shipping-info">
       <div class="shipping-item">
         <span class="shipping-icon">🌍</span>
         <span class="shipping-text">Global Shipping</span>
       </div>
       <div class="shipping-item">
         <span class="shipping-icon">📦</span>
         <span class="shipping-text">US/Mexico Fulfillment</span>
       </div>
       <div class="shipping-item">
         <span class="shipping-icon">🎨</span>
         <span class="shipping-text">Core Colors Available</span>
       </div>
        <div class="shipping-item">
          <span class="shipping-icon">✅</span>
          <span class="shipping-text">3-14 Day Delivery</span>
        </div>
     </div>
   </div>

  <!-- Main Layout -->
  <div class="main-container">
    <!-- Left Column - Two Stacked Windows (Video Preview Removed) -->
    <div class="left-column">
      <!-- Top Window: Screenshots Selected -->
               <div class="screenshots-selected" id="screenshotsSelected">
           <h3>Select A Screenshot</h3>
           <div class="screenshot-preview-row" id="screenshotPreviewRow">
             <!-- Video thumbnail will be auto-inserted here -->
           </div>
         </div>
      
      <!-- Bottom Window: Products Selected -->
      <div class="products-selected" id="productsSelected">
        <h3>Products Selected</h3>
        <div class="selected-products" id="selectedProducts">
          <p>No products selected yet</p>
        </div>
        <button class="btn checkout-btn" onclick="goToCheckout()" style="margin-top: 15px; width: 100%;">Go to Checkout</button>
      </div>
    </div>

    <!-- Right Column - Available Products -->
    <div class="products-section" id="productsSection">
      {% if show_category_selection %}
      <!-- Category Selection Landing -->
      <div class="category-selection-landing" style="text-align: center; padding: 40px 20px; box-sizing: border-box !important; overflow-x: hidden !important; width: 100% !important;">
        <h3 style="font-size: 2rem; margin-bottom: 10px; color: #333;">Choose a Product</h3>
        <p style="color: #666; margin-bottom: 30px;">Select a category to browse products for your custom merchandise</p>
        
        <div class="category-grid">
          <div class="category-card" onclick="switchCategory('womens')" style="cursor: pointer; padding: 20px; background: #f8f9fa; border-radius: 12px; transition: all 0.3s; border: 2px solid transparent;">
            <span style="font-size: 2.5rem; display: block; margin-bottom: 8px;">👩</span>
            <span style="font-weight: 600; color: #333;">Women's</span>
          </div>
          <div class="category-card" onclick="switchCategory('mens')" style="cursor: pointer; padding: 20px; background: #f8f9fa; border-radius: 12px; transition: all 0.3s; border: 2px solid transparent;">
            <span style="font-size: 2.5rem; display: block; margin-bottom: 8px;">👨</span>
            <span style="font-weight: 600; color: #333;">Men's</span>
          </div>
          <div class="category-card" onclick="switchCategory('kids')" style="cursor: pointer; padding: 20px; background: #f8f9fa; border-radius: 12px; transition: all 0.3s; border: 2px solid transparent;">
            <span style="font-size: 2.5rem; display: block; margin-bottom: 8px;">🧒</span>
            <span style="font-weight: 600; color: #333;">Kids</span>
          </div>
          <div class="category-card" onclick="switchCategory('pets')" style="cursor: pointer; padding: 20px; background: #f8f9fa; border-radius: 12px; transition: all 0.3s; border: 2px solid transparent;">
            <span style="font-size: 2.5rem; display: block; margin-bottom: 8px;">🐕</span>
            <span style="font-weight: 600; color: #333;">Pets</span>
          </div>
          <div class="category-card" onclick="switchCategory('mugs')" style="cursor: pointer; padding: 20px; background: #f8f9fa; border-radius: 12px; transition: all 0.3s; border: 2px solid transparent;">
            <span style="font-size: 2.5rem; display: block; margin-bottom: 8px;">☕</span>
            <span style="font-weight: 600; color: #333;">Mugs</span>
          </div>
          <div class="category-card" onclick="switchCategory('hats')" style="cursor: pointer; padding: 20px; background: #f8f9fa; border-radius: 12px; transition: all 0.3s; border: 2px solid transparent;">
            <span style="font-size: 2.5rem; display: block; margin-bottom: 8px;">🧢</span>
            <span style="font-weight: 600; color: #333;">Hats</span>
          </div>
          <div class="category-card" onclick="switchCategory('bags')" style="cursor: pointer; padding: 20px; background: #f8f9fa; border-radius: 12px; transition: all 0.3s; border: 2px solid transparent;">
            <span style="font-size: 2.5rem; display: block; margin-bottom: 8px;">👜</span>
            <span style="font-weight: 600; color: #333;">Bags</span>
          </div>
          <div class="category-card" onclick="switchCategory('home-living')" style="cursor: pointer; padding: 20px; background: #f8f9fa; border-radius: 12px; transition: all 0.3s; border: 2px solid transparent;">
            <span style="font-size: 2.5rem; display: block; margin-bottom: 8px;">🏠</span>
            <span style="font-weight: 600; color: #333;">Home&Living</span>
          </div>
          <div class="category-card" onclick="switchCategory('misc')" style="cursor: pointer; padding: 20px; background: #f8f9fa; border-radius: 12px; transition: all 0.3s; border: 2px solid transparent;">
            <span style="font-size: 2.5rem; display: block; margin-bottom: 8px;">📦</span>
            <span style="font-weight: 600; color: #333;">Miscellaneous</span>
          </div>
          <div class="category-card" onclick="switchCategory('thumbnails')" style="cursor: pointer; padding: 20px; background: #f8f9fa; border-radius: 12px; transition: all 0.3s; border: 2px solid transparent;">
            <span style="font-size: 2.5rem; display: block; margin-bottom: 8px;">🖼️</span>
            <span style="font-weight: 600; color: #333;">Thumbnails</span>
          </div>
        </div>
      </div>
      {% else %}
      <h3>Available Products</h3>
      <div class="product-row" id="productRow"></div>
      {% endif %}
    </div>
  </div>

  <script>
    console.log('🔍 BACKEND SCRIPT LOADING - Template script starting...');
    console.log('🔍 CACHE BUSTER: {{ cache_buster }}');
    console.log('🔍 TIMESTAMP: {{ timestamp }}');
    
    // Force cache bypass by adding a query parameter
    if (!window.location.search.includes('v=')) {
      const url = new URL(window.location);
      url.searchParams.set('v', '{{ cache_buster }}');
      console.log('🔍 FORCING CACHE BYPASS - Redirecting to:', url.toString());
      window.location.replace(url.toString());
    }
    
    // Global variables - Make them more robust against conflicts
    window.products = window.products || [];
    let products = window.products;
    
    console.log('🔍 BACKEND SCRIPT - Products array initialized:', products);

    // Price update function - Make it more robust against conflicts
    // Use a unique name to avoid conflicts with frontend scripts
    window.backendUpdatePrice = function(productIndex, selectedSize) {
      console.log('🔍 BACKEND updatePrice function DEFINED and called:', productIndex, selectedSize);
      console.log('🔍 BACKEND updatePrice called:', productIndex, selectedSize);
      console.log('🔍 updatePrice called:', productIndex, selectedSize);
      console.log('🔍 Products array length:', products.length);
      console.log('🔍 Products array:', products);
      console.log('🔍 Products array details at updatePrice:', products.map((p, i) => ({ index: i, name: p?.name, hasSizePricing: !!p?.size_pricing })));
      
      // Check if products array exists and has the expected length
      if (!products || !Array.isArray(products)) {
        console.log('❌ Products array is not valid:', products);
        return;
      }
      
      if (productIndex < 0 || productIndex >= products.length) {
        console.log('❌ Product index out of range:', productIndex, 'Array length:', products.length);
        return;
      }
      
      if (!products[productIndex]) {
        console.log('❌ Product not found at index:', productIndex);
        console.log('🔍 Available products:', products.map((p, i) => ({ index: i, name: p?.name })));
        return;
      }
      
      const product = products[productIndex];
      console.log('🔍 Product data:', product);
      console.log('🔍 Product name:', product.name);
      console.log('🔍 Product size_pricing:', product.size_pricing);
      
      const basePrice = product.price;
      const sizePricing = product.size_pricing || {};
      const sizeIncrease = sizePricing[selectedSize] || 0;
      const totalPrice = basePrice + sizeIncrease;
      
      console.log('🔍 Price calculation:', { basePrice, sizePricing, sizeIncrease, totalPrice });
      
      const priceElement = document.getElementById(`price-${productIndex}`);
      if (priceElement) {
        priceElement.textContent = `$${totalPrice.toFixed(2)}`;
        if (sizeIncrease > 0) {
          priceElement.innerHTML = `$${totalPrice.toFixed(2)} <span style="font-size: 0.8em; color: #666;">(+$${sizeIncrease.toFixed(2)})</span>`;
        }
        console.log('🔍 Price updated to:', priceElement.textContent);
      } else {
        console.log('🔍 Price element not found:', `price-${productIndex}`);
      }
    }

    // JavaScript functions for clickable flow steps
    function scrollToProducts() {
      document.getElementById('productsSelected').scrollIntoView({ 
        behavior: 'smooth',
        block: 'start'
      });
    }

    function goToCheckout() {
      console.log('🛒 goToCheckout function called');
      
      const selectedProducts = document.getElementById('selectedProducts');
      console.log('🛒 selectedProducts element:', selectedProducts);
      console.log('🛒 selectedProducts children length:', selectedProducts ? selectedProducts.children.length : 'element not found');
      
      if (!selectedProducts) {
        alert('Error: Could not find selected products container');
        return;
      }
      
      if (selectedProducts.children.length === 0) {
        alert('Please add some products to your cart first!');
        return;
      }
      
      // Collect all selected products for checkout
      const selectedProductsForCheckout = [];
      selectedProducts.querySelectorAll('div').forEach(item => {
        const nameElement = item.querySelector('div');
        const detailsElement = item.querySelector('div:nth-child(2)');
        const imageElement = item.querySelector('img');
        
        if (nameElement && detailsElement) {
          const productName = nameElement.textContent;
          const details = detailsElement.textContent;
          const image = imageElement ? imageElement.src : '';
          
          selectedProductsForCheckout.push({
            name: productName,
            details: details,
            image: image
          });
        }
      });
      
      console.log('🛒 Proceeding to checkout with:', selectedProductsForCheckout);
      
      // Redirect to checkout page with product data
      const productId = '{{ product_id }}';
      const checkoutUrl = `/checkout/${productId}`;
      
      console.log('🛒 Redirecting to:', checkoutUrl);
      
      // Store cart data in sessionStorage for checkout page
      sessionStorage.setItem('cartData', JSON.stringify(selectedProductsForCheckout));
      
      // Redirect to checkout
      window.location.href = checkoutUrl;
    }

         // Initialize the page
     document.addEventListener('DOMContentLoaded', function() {
       // Remove resolution notice immediately
       const resolutionNotice = document.getElementById('resolutionNotice');
       if (resolutionNotice) {
         resolutionNotice.remove();
       }
       
       // Also remove any text containing "Maximum resolution"
       const allElements = document.querySelectorAll('*');
       allElements.forEach(element => {
         if (element.textContent && element.textContent.includes('Maximum resolution')) {
           element.remove();
         }
       });
       
       // Video preview removed - now auto-insert video thumbnail and screenshots

      // Get video thumbnail and screenshots
      const videoThumbnail = '{{ img_url }}'; // Video thumbnail from backend
      const screenshots = [];
      {% if screenshots %}
        {% for screenshot in screenshots %}
          screenshots.push('{{ screenshot }}');
        {% endfor %}
      {% endif %}

      // Display video thumbnail and screenshots in the top window
      const row = document.getElementById("screenshotPreviewRow");
      
      // Video thumbnail is automatically included in screenshots array from frontend
      // No need to add it separately here to avoid duplication

      // Create screenshot thumbnails container
      const thumbnailsContainer = document.createElement("div");
      thumbnailsContainer.className = "screenshot-thumbnails";
      
      // Add screenshots below video thumbnail in grid layout
      screenshots.forEach(src => {
        const img = document.createElement("img");
        img.src = src + '?v=' + Date.now(); // Add timestamp to prevent caching
        img.className = "screenshot-thumbnail";
        img.addEventListener('click', function() {
          setSelectedImage(img, src);
        });
        thumbnailsContainer.appendChild(img);
      });
      
             // Add the thumbnails container to the row
       row.appendChild(thumbnailsContainer);
       
       // Remove any resolution notice if it exists
       const resolutionNotice = document.getElementById('resolutionNotice');
       if (resolutionNotice) {
         resolutionNotice.remove();
       }

      // Populate products - Protect against overwrites
      if (!window.products || window.products.length === 0) {
        products = [];
        window.products = products;
      } else {
        products = window.products;
        console.log('🔍 Using existing products array:', products.length, 'items');
      }
      
      {% if products %}
        {% for product in products %}
          products.push({
            name: '{{ product.name }}',
            price: {{ product.price }},
            main_image: '{{ product.main_image }}',
            filename: '{{ product.filename }}',
            options: {{ product.options | tojson }},
            size_pricing: {{ product.size_pricing | tojson if product.size_pricing else '{}' }}
          });
          console.log('🔍 Product loaded:', '{{ product.name }}', 'Size pricing:', {{ product.size_pricing | tojson if product.size_pricing else '{}' }});
          console.log('🔍 Product keys:', Object.keys({
            name: '{{ product.name }}',
            price: {{ product.price }},
            main_image: '{{ product.main_image }}',
            filename: '{{ product.filename }}',
            options: {{ product.options | tojson }},
            size_pricing: {{ product.size_pricing | tojson if product.size_pricing else '{}' }}
          }));
        {% endfor %}
      {% endif %}
      console.log('🔍 All products loaded:', products);
      console.log('🔍 Products array details:', products.map((p, i) => ({ index: i, name: p?.name, hasSizePricing: !!p?.size_pricing })));
      console.log('🔍 Backend products data:', {{ products | tojson if products else '[]' }});

      // Display products
      const productRow = document.getElementById("productRow");
      products.forEach((product, index) => {
        const productCard = document.createElement("div");
        productCard.className = "product-card";
        productCard.innerHTML = `
          <img src="/static/images/${product.main_image}" alt="${product.name}" style="width:100%;height:180px;object-fit:cover;border-radius:6px;">
          <div class="product-title">${product.name}</div>
          <div class="product-price" id="price-${index}">$${product.price.toFixed(2)}</div>
          ${product.options.color ? `
            <div style="font-weight:bold; color:#3f51b5; margin-bottom:6px;">Choose Color & Size:</div>
            <div class="variant-selector">
              <label>Color:</label>
              <select class="variant-select color-select">
                ${product.options.color.map(color => `<option value="${color}">${color}</option>`).join('')}
              </select>
            </div>
          ` : ''}
          ${product.options.size ? `
            <div class="variant-selector">
              <label>Size:</label>
              <select class="variant-select size-select" data-product-index="${index}" onchange="backendUpdatePrice(${index}, this.value)">
                ${product.options.size.map(size => `<option value="${size}">${size}</option>`).join('')}
              </select>
            </div>
          ` : ''}
                     <textarea class="note-input" placeholder="Add a note (optional)"></textarea>
           <hr style="margin: 8px 0; border: none; border-top: 1px solid #eee;">
          <button class="btn add-to-cart-btn">Add ${product.name} to Cart</button>
        `;
        productRow.appendChild(productCard);
      });

      // Image selection logic
      let selectedImageUrl = null;
      function setSelectedImage(imgEl, src) {
        document.querySelectorAll('.selected-image').forEach(el => el.classList.remove('selected-image'));
        imgEl.classList.add('selected-image');
        selectedImageUrl = src;
      }

      // Set default selected image
      if (screenshots.length > 0) {
        setSelectedImage(row.firstChild, screenshots[0]);
      }
    });

    // Authentication check on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Check if user is already authenticated
      const savedEmail = localStorage.getItem('cartEmail');
      const isAuthenticated = sessionStorage.getItem('authenticated');
      
      if (!savedEmail && !isAuthenticated) {
        // Show authentication modal
        document.getElementById('email-auth-overlay').style.display = 'flex';
        document.getElementById('authenticated-content').style.display = 'none';
      } else {
        // User is authenticated, show content
        document.getElementById('email-auth-overlay').style.display = 'none';
        document.getElementById('authenticated-content').style.display = 'block';
      }
    });

        // --- Auto-crop function ---
    function autoCropImage(url, callback) {
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = function() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // Set canvas size to match image
        canvas.width = img.width;
        canvas.height = img.height;
        
        // Draw image on canvas
        ctx.drawImage(img, 0, 0);
        
        // Convert to data URL and callback
        const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
        callback(dataUrl);
      };
      img.onerror = function() {
        // If image fails to load, just use the original URL
        callback(url);
      };
      img.src = url;
    }
    
    // Backup function to ensure our updatePrice works even if frontend overrides it
    window.updatePrice = window.backendUpdatePrice;
    
    // Also create a fallback that runs after a delay to override any frontend scripts
    setTimeout(() => {
      window.updatePrice = window.backendUpdatePrice;
      console.log('🔍 Backup updatePrice function installed');
    }, 1000);
    
    // Category switching function
    function switchCategory(category) {
      console.log('🔍 Switching to category:', category);
      const currentUrl = new URL(window.location);
      currentUrl.searchParams.set('category', category);
      window.location.href = currentUrl.toString();
    }
  </script>
</body>
</html>