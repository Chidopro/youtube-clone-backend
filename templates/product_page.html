<!DOCTYPE html>
<html>
<head>
  <title>Customize Your Product</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; background: #f8f8f8; text-align: center; padding: 40px; margin-right: 320px; margin-left: 180px; }
    h1 { color: #3f51b5; }
    .preview-image {
      max-width: 360px;
      width: 360px;
      height: auto;
      margin-bottom: 10px;
      border-radius: 10px;
      cursor: pointer;
      box-sizing: border-box;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    .screenshot-preview-row { 
      display: flex; 
      justify-content: center; 
      gap: 10px; 
      max-width: 800px; 
      margin: 10px auto 30px auto;
      flex-wrap: wrap;
    }
    .screenshot-preview-row img {
      width: 120px;
      height: auto;
      border-radius: 4px;
      border: 2px solid #ccc;
      object-fit: cover;
      cursor: pointer;
      box-sizing: border-box;
    }
    .selected-image {
      border: 4px solid #4CAF50 !important;
      box-shadow: 0 0 8px #4CAF50;
      box-sizing: border-box;
    }
    .product-row { 
      display: grid; 
      grid-template-columns: repeat(3, 1fr); 
      gap: 20px; 
      margin-top: 30px; 
      justify-items: center;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    .product-card { background: #fff; padding: 20px; border-radius: 12px; width: 240px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .product-card img { width: 100%; height: auto; border-radius: 6px; margin-bottom: 10px; }
    .product-title { font-weight: bold; margin: 10px 0 5px; }
    .product-price { color: #444; margin-bottom: 10px; }
    .note-input { width: 100%; padding: 6px; margin-bottom: 12px; border: 1px solid #ccc; border-radius: 4px; }
    .variant-selector { margin-bottom: 12px; background: #f0f4ff; border: 1px solid #bfcfff; border-radius: 6px; padding: 10px; }
    .variant-selector label { display: block; text-align: left; margin-bottom: 4px; color: #3f51b5; font-weight: bold; }
    .variant-selector select { width: 100%; padding: 6px; border: 1.5px solid #3f51b5; border-radius: 4px; background: #fff; }
    .btn { background: #3f51b5; color: white; padding: 10px 16px; border: none; border-radius: 4px; cursor: pointer; }
    .btn:hover { background: #2c3cb5; }
    #cart-sidebar { 
      position: fixed;
      top: 40px;
      right: 0; 
      width: 300px; 
      background: white; 
      box-shadow: -2px 0 10px rgba(0,0,0,0.1); 
      padding: 20px 20px 20px 20px;
      overflow-y: auto; 
      box-sizing: border-box;
      min-height: 120px;
      border-radius: 0 0 12px 12px;
      z-index: 1000;
    }
    #cart-sidebar h2 {
      font-size: 20px;
      margin-bottom: 10px;
      color: #3f51b5;
      background: #f0f0f0;         /* Light grey background */
      padding: 12px 0;
      border-radius: 8px;
      border: 1.5px solid #e0e0e0; /* Subtle border */
      box-shadow: 0 2px 6px rgba(0,0,0,0.04); /* Optional subtle shadow */
      text-align: center;
      font-weight: bold;
      letter-spacing: 1px;
    }
    .cart-item { text-align: left; border-bottom: 1px solid #eee; padding: 10px 0; }
    .cart-item img {
      width: 120px;
      height: auto;
      border-radius: 4px;
      margin-bottom: 6px;
      object-fit: cover;
      box-sizing: border-box;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    .checkout-btn { 
      /* position: fixed; 
      bottom: 30px; 
      right: 40px; */
      width: 100%;
      padding: 12px; 
      background: #4CAF50; 
      color: white; 
      border: none; 
      border-radius: 4px; 
      font-size: 16px; 
      margin-top: 20px;
      z-index: 1001;
    }
    .cart-delete-btn {
      background: #e53935;
      color: white;
      border: none;
      border-radius: 3px;
      font-size: 12px;
      padding: 4px 10px;
      margin: 4px 0 6px 0;
      cursor: pointer;
      display: block;
      width: 60px;
      transition: background 0.2s;
    }
    .cart-delete-btn:hover {
      background: #b71c1c;
    }
    .resolution-notice {
      background-color: #FFF3CD;
      color: #856404;
      padding: 10px;
      border-radius: 5px;
      margin: 10px auto;
      max-width: 600px;
      border-left: 4px solid #FFD700;
      text-align: left;
      display: none;
    }
    #logo-sidebar {
      position: absolute;
      top: 40px;
      left: 0;
      width: 160px;
      background: transparent;
      box-shadow: none;
      padding: 0;
      min-height: unset;
      border-radius: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .image-gallery {
      margin: 30px auto 20px auto;
      max-width: 800px;
    }
    .gallery-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
    }
    .gallery-image {
      width: 120px;
      height: auto;
      border-radius: 6px;
      border: 2px solid #ccc;
      cursor: pointer;
      transition: border 0.2s, box-shadow 0.2s;
    }
    .gallery-image.selected-image {
      border: 4px solid #4CAF50 !important;
      box-shadow: 0 0 8px #4CAF50;
    }
    .hoodie-position {
      object-position: center top !important;
    }
  </style>
</head>
<body>
  <div id="logo-sidebar">
    <img src="/static/icons/screenmerch_logo.png" alt="ScreenMerch Logo" style="width:90px; display:block; margin:auto; background:none; box-shadow:none;">
  </div>
  <!-- Thumbnail -->
  <img id="thumbnailImage" class="preview-image" alt="Selected Thumbnail">
  <div class="screenshot-preview-row" id="screenshotPreviewRow"></div>
  <div id="resolutionNotice" class="resolution-notice">
    <strong>Notice:</strong> Maximum resolution is not available. Please select a lower resolution option from the thumbnails below.
  </div>

  <h1>Customize Your Product</h1>

  <!-- Transparent Email Auth Overlay -->
  <div id="email-auth-overlay" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(255,255,255,0.7);z-index:2000;display:flex;align-items:center;justify-content:center;">
    <div style="background:rgba(255,255,255,0.95);border-radius:16px;box-shadow:0 4px 32px #0002;padding:32px 32px 24px 32px;min-width:320px;max-width:90vw;text-align:center;position:relative;">
      <h2 style="margin-bottom:18px;color:#3f51b5;">Sign In Required</h2>
      <p style="margin-bottom:20px;color:#666;font-size:14px;">You must sign in to access the product page and make purchases.</p>
      <form id="email-auth-form" onsubmit="return false;" style="margin-bottom: 10px;">
        <input type="email" id="auth-email" placeholder="Email" required style="padding: 10px; width: 90%; margin-bottom: 10px; border-radius:6px; border:1px solid #bbb;" />
        <input type="password" id="auth-password" placeholder="Password" required style="padding: 10px; width: 90%; margin-bottom: 10px; border-radius:6px; border:1px solid #bbb;" />
        <br />
        <button type="button" onclick="handleEmailLogin()" style="padding: 10px 20px; margin-right: 8px; border-radius:6px; background:#3f51b5; color:white; border:none;">Login</button>
        <button type="button" onclick="handleEmailSignup()" style="padding: 10px 20px; border-radius:6px; background:#4CAF50; color:white; border:none;">Create Account</button>
      </form>
      <div id="email-auth-message" style="color: #e53935; margin-bottom: 8px;"></div>
      <div style="font-size:13px;color:#666;margin-top:10px;">
        <a href="#" onclick="handleForgotPassword()" style="color: #3f51b5; text-decoration: none;">Forgot Password?</a>
      </div>
      <div style="font-size:13px;color:#666;margin-top:10px;">Authentication is required to proceed.<br>Please sign in or create an account.</div>
    </div>
  </div>

  <!-- Hidden content that only shows after authentication -->
  <div id="authenticated-content" style="display: none;">
  <div class="product-row">
    {% for product in products %}
    <div class="product-card">
            <!-- Main product image -->      <img src="{{ url_for('static', filename='images/' + product.main_image) }}" alt="{{ product.name }}" style="width:100%;height:180px;object-fit:cover;border-radius:6px;" class="{% if product.name == 'Unisex Hoodie' or product.name == 'Unisex Champion Hoodie' or product.name == 'Women\'s Shirt' or product.name == 'Women\'s HD Shirt' or product.name == 'Women\'s Ribbed Neck' %}hoodie-position{% endif %}">
      <div class="product-title">{{ product.name }}</div>
      <div class="product-price">${{ '%.2f'|format(product.price) }}</div>
      {% if product.options.color %}
      <div style="font-weight:bold; color:#3f51b5; margin-bottom:6px;">Choose Color & Size:</div>
      <div class="variant-selector">
        <label>Color:</label>
        <select class="variant-select color-select">
          {% for color in product.options.color %}
          <option value="{{ color }}">{{ color }}</option>
          {% endfor %}
        </select>
      </div>
      {% endif %}
      {% if product.options.size %}
      <div class="variant-selector">
        <label>Size:</label>
        <select class="variant-select size-select">
          {% for size in product.options.size %}
          <option value="{{ size }}">{{ size }}</option>
          {% endfor %}
        </select>
      </div>
      {% endif %}
      <textarea class="note-input" placeholder="Add a note (optional)"></textarea>
      <button class="btn add-to-cart-btn">Add {{ product.name }} to Cart</button>
      <!-- Preview window -->
      <div class="preview-label" style="margin-top:10px;font-size:13px;color:#888;">Preview</div>
      <div class="product-preview-thumb" style="width:80px;height:80px;margin:0 auto;position:relative;cursor:pointer;">
        <img src="{{ url_for('static', filename='images/' + product.filename) }}" alt="Preview" style="width:100%;height:100%;object-fit:cover;border-radius:6px;border:1.5px solid #bbb;box-shadow:0 1px 4px #0001;">
        <div class="enlarged-preview" style="display:none;position:absolute;top:-10px;left:90px;width:220px;height:220px;z-index:10;background:white;border-radius:10px;box-shadow:0 4px 16px #0002;border:2px solid #4CAF50;align-items:center;justify-content:center;overflow:hidden;">
          <img src="{{ url_for('static', filename='images/' + product.filename) }}" alt="Preview Large" style="width:100%;height:100%;object-fit:contain;">
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <div id="cart-sidebar">
    <h2>Your Cart</h2>
    <div id="cart-items"></div>
    <button class="checkout-btn" onclick="goToCheckout()">Proceed to Checkout</button>
  </div>
  </div>

  <script>
    // Authentication check on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Check if user is already authenticated
      const savedEmail = localStorage.getItem('cartEmail');
      const isAuthenticated = sessionStorage.getItem('authenticated');
      
      if (!savedEmail && !isAuthenticated) {
        // Show authentication modal
        document.getElementById('email-auth-overlay').style.display = 'flex';
        document.getElementById('authenticated-content').style.display = 'none';
      } else {
        // User is authenticated, show content
        document.getElementById('email-auth-overlay').style.display = 'none';
        document.getElementById('authenticated-content').style.display = 'block';
      }
    });

    // --- Auto-crop function ---
    function autoCropImage(url, callback) {
      const img = new Image();
      img.crossOrigin = "Anonymous";
      img.onload = function () {
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const { data, width, height } = imageData;
        let top = 0, bottom = height, left = 0, right = width;
        const isWhiteOrBlack = (r, g, b) =>
          (r > 230 && g > 230 && b > 230) || (r < 25 && g < 25 && b < 25);
        function scanTop() {
          for (let y = 0; y < height; y++) {
            for (let x = 0; x < width; x++) {
              const i = (y * width + x) * 4;
              if (!isWhiteOrBlack(data[i], data[i+1], data[i+2])) {
                top = y;
                return;
              }
            }
          }
        }
        function scanBottom() {
          for (let y = height - 1; y >= 0; y--) {
            for (let x = 0; x < width; x++) {
              const i = (y * width + x) * 4;
              if (!isWhiteOrBlack(data[i], data[i+1], data[i+2])) {
                bottom = y;
                return;
              }
            }
          }
        }
        function scanLeft() {
          for (let x = 0; x < width; x++) {
            for (let y = 0; y < height; y++) {
              const i = (y * width + x) * 4;
              if (!isWhiteOrBlack(data[i], data[i+1], data[i+2])) {
                left = x;
                return;
              }
            }
          }
        }
        function scanRight() {
          for (let x = width - 1; x >= 0; x--) {
            for (let y = 0; y < height; y++) {
              const i = (y * width + x) * 4;
              if (!isWhiteOrBlack(data[i], data[i+1], data[i+2])) {
                right = x;
                return;
              }
            }
          }
        }
        scanTop(); scanBottom(); scanLeft(); scanRight();
        const croppedW = right - left;
        const croppedH = bottom - top;
        const croppedCanvas = document.createElement("canvas");
        croppedCanvas.width = croppedW;
        croppedCanvas.height = croppedH;
        const croppedCtx = croppedCanvas.getContext("2d");
        croppedCtx.drawImage(canvas, left, top, croppedW, croppedH, 0, 0, croppedW, croppedH);
        callback(croppedCanvas.toDataURL());
      };
      img.src = url;
    }
    // --- End auto-crop function ---

    // Get data from template variables or URL parameters (for backwards compatibility)
    const email = '{{ email }}' || new URLSearchParams(window.location.search).get('email') || '';
    const img = '{{ img_url }}' || new URLSearchParams(window.location.search).get('img') || '';
    const screenParam = new URLSearchParams(window.location.search).get('screens');
    const channel = '{{ channel_id }}' || new URLSearchParams(window.location.search).get('channel') || window.location.pathname.split('/')[2];
    const maxResAvailable = new URLSearchParams(window.location.search).get('maxres') !== 'false';
    const resolutionNotice = document.getElementById('resolutionNotice');

    // Show resolution notice if max resolution is not available
    if (!maxResAvailable) {
      resolutionNotice.style.display = 'block';
    }

    // --- Cart reset logic ---
    const lastChannel = localStorage.getItem('lastChannel');
    if (channel && channel !== lastChannel) {
      localStorage.removeItem('cart');
    }
    localStorage.setItem('lastChannel', channel);
    // --- End cart reset logic ---

    // Set and crop the main thumbnail
    const thumbnailImage = document.getElementById("thumbnailImage");
    autoCropImage(img, function(croppedDataUrl) {
      thumbnailImage.src = croppedDataUrl;
    });

    // Add click event to select the thumbnail
    thumbnailImage.addEventListener('click', function() {
      setSelectedImage(thumbnailImage, thumbnailImage.src);
    });

    // Get screenshots from template or URL parameters
    let screenshots = [];
    {% if screenshots %}
      // Use screenshots passed from template
      {% for screenshot in screenshots %}
        screenshots.push('{{ screenshot }}');
      {% endfor %}
    {% else %}
      // Fallback to reading from URL parameters
      for (let i = 1; i <= 5; i++) {
        const url = new URLSearchParams(window.location.search).get(`screen${i}`);
        if (url) screenshots.push(url);
      }
    {% endif %}
    
    console.log("Email:", email);
    console.log("Main image:", img);
    console.log("Screenshots array:", screenshots);

    // Image selection logic
    let selectedImageUrl = null;
    const row = document.getElementById("screenshotPreviewRow");
    row.innerHTML = "";

    function setSelectedImage(imgEl, src) {
      document.querySelectorAll('.selected-image').forEach(el => el.classList.remove('selected-image'));
      imgEl.classList.add('selected-image');
      selectedImageUrl = src;
    }

    // Crop and display screenshots
    screenshots.forEach(src => {
      autoCropImage(src, function(croppedDataUrl) {
        const img = document.createElement("img");
        img.src = croppedDataUrl;
        img.addEventListener('click', function() {
          setSelectedImage(img, croppedDataUrl);
        });
        row.appendChild(img);
        // By default, select the thumbnail
        if (!selectedImageUrl) {
          setSelectedImage(thumbnailImage, thumbnailImage.src);
        }
      });
    });

    // By default, select the thumbnail after it loads
    thumbnailImage.addEventListener('load', function() {
      if (!selectedImageUrl) {
        setSelectedImage(thumbnailImage, thumbnailImage.src);
      }
    });

    const cartItemsContainer = document.getElementById('cart-items');
    let cart = JSON.parse(localStorage.getItem('cart')) || [];

    function updateCartSidebar() {
      cartItemsContainer.innerHTML = '';
      cart.forEach((item, idx) => {
        const div = document.createElement('div');
        div.className = 'cart-item';
        let variantText = '';
        if (item.variants) {
          if (item.variants.color) variantText += `Color: ${item.variants.color}<br>`;
          if (item.variants.size) variantText += `Size: ${item.variants.size}<br>`;
        }
        div.innerHTML = `
          <img src="${item.img}" alt="Selected" style="width: 120px !important; height: auto; border-radius: 4px; margin-bottom: 6px; object-fit: cover; display: block; margin-left: auto; margin-right: auto;">
          <button class="cart-delete-btn" data-index="${idx}">Delete</button>
          <strong>${item.product}</strong><br>
          ${variantText}
          Note: ${item.note || 'None'}<br>
        `;
        cartItemsContainer.appendChild(div);
      });
      // Add event listeners for delete buttons
      document.querySelectorAll('.cart-delete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const idx = parseInt(this.getAttribute('data-index'));
          cart.splice(idx, 1);
          localStorage.setItem('cart', JSON.stringify(cart));
          updateCartSidebar();
        });
      });
    }

    function goToCheckout() {
      if (cart.length === 0) return alert("Cart is empty");
      window.location.href = `/checkout/{{ product_id }}`;
    }

    // Add this Imgur upload function to the script
    async function uploadToImgur(base64Image) {
      const response = await fetch("https://api.imgur.com/3/image", {
        method: "POST",
        headers: {
          Authorization: "Client-ID 792f7248acd8df0",
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          image: base64Image.split(',')[1],
          type: "base64"
        })
      });
      const contentType = response.headers.get('Content-Type') || '';
      if (!contentType.includes('application/json')) {
        const text = await response.text();
        throw new Error("Imgur upload failed: " + (text.includes('<') ? 'Imgur may be rate limited or returned an error.' : text));
      }
      const data = await response.json();
      if (!data.success) throw new Error("Imgur upload failed: " + (data.data?.error || 'Unknown error'));
      return data.data.link;
    }

    // Add-to-cart logic for all product cards
    document.querySelectorAll('.add-to-cart-btn').forEach(button => {
      button.addEventListener('click', async () => {
        if (!selectedImageUrl) {
          alert("Please select a thumbnail or screenshot from the top first!");
          return;
        }
        const card = button.closest('.product-card');
        const product = card.querySelector('.product-title').innerText;
        const note = card.querySelector('.note-input').value;
        const imgToStore = selectedImageUrl;
        let variants = {};
        const colorSelect = card.querySelector('.color-select');
        const sizeSelect = card.querySelector('.size-select');
        if (colorSelect) variants.color = colorSelect.value;
        if (sizeSelect) variants.size = sizeSelect.value;
        cart.push({ product, note, email, img: imgToStore, variants });
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartSidebar();
      });
    });

    updateCartSidebar();

    // Make gallery images selectable and update selectedImageUrl
    document.addEventListener('DOMContentLoaded', function() {
      const galleryImages = document.querySelectorAll('.gallery-image');
      galleryImages.forEach(img => {
        img.addEventListener('click', function() {
          galleryImages.forEach(el => el.classList.remove('selected-image'));
          img.classList.add('selected-image');
          selectedImageUrl = img.getAttribute('data-img');
        });
      });
      // Select the first image by default if none selected
      if (galleryImages.length > 0 && !selectedImageUrl) {
        galleryImages[0].classList.add('selected-image');
        selectedImageUrl = galleryImages[0].getAttribute('data-img');
      }
    });

    // Preview enlarge on hover logic
    document.querySelectorAll('.product-preview-thumb').forEach(function(preview) {
      const enlarged = preview.querySelector('.enlarged-preview');
      preview.addEventListener('mouseenter', function() {
        enlarged.style.display = 'flex';
      });
      preview.addEventListener('mouseleave', function() {
        enlarged.style.display = 'none';
      });
    });

    // --- Email Auth Functions (moved here to avoid linter errors) ---
    function setCartEmail(email) {
      cart.forEach(item => { item.email = email; });
      localStorage.setItem('cart', JSON.stringify(cart));
      updateCartSidebar();
    }

    function handleEmailLogin() {
      const email = document.getElementById('auth-email').value.trim();
      const password = document.getElementById('auth-password').value;
      const messageDiv = document.getElementById('email-auth-message');
      const loginBtn = document.querySelector('button[onclick="handleEmailLogin()"]');
      const signupBtn = document.querySelector('button[onclick="handleEmailSignup()"]');
      
      messageDiv.style.color = '#e53935';
      if (!email || !password) {
        messageDiv.textContent = 'Please enter both email and password.';
        return;
      }

      // Disable buttons during authentication
      loginBtn.disabled = true;
      signupBtn.disabled = true;
      loginBtn.textContent = 'Logging in...';
      
      // Real authentication call
      fetch('/api/auth/login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email, password })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          setCartEmail(email);
          sessionStorage.setItem('authenticated', 'true');
          messageDiv.style.color = '#4CAF50';
          messageDiv.textContent = 'Login successful! Email saved.';
          setTimeout(() => {
            document.getElementById('email-auth-overlay').style.display = 'none';
            document.getElementById('authenticated-content').style.display = 'block'; // Show authenticated content
          }, 1000);
        } else {
          messageDiv.textContent = data.error || 'Login failed. Please check your credentials.';
        }
      })
      .catch(error => {
        console.error('Login error:', error);
        messageDiv.textContent = 'Login failed. Please try again.';
      })
      .finally(() => {
        // Re-enable buttons
        loginBtn.disabled = false;
        signupBtn.disabled = false;
        loginBtn.textContent = 'Login';
      });
    }

    function handleEmailSignup() {
      const email = document.getElementById('auth-email').value.trim();
      const password = document.getElementById('auth-password').value;
      const messageDiv = document.getElementById('email-auth-message');
      const loginBtn = document.querySelector('button[onclick="handleEmailLogin()"]');
      const signupBtn = document.querySelector('button[onclick="handleEmailSignup()"]');
      
      messageDiv.style.color = '#e53935';
      if (!email || !password) {
        messageDiv.textContent = 'Please enter both email and password.';
        return;
      }

      if (password.length < 6) {
        messageDiv.textContent = 'Password must be at least 6 characters long.';
        return;
      }

      // Disable buttons during authentication
      loginBtn.disabled = true;
      signupBtn.disabled = true;
      signupBtn.textContent = 'Creating Account...';
      
      // Real signup call with redirect URL
      fetch('/api/auth/signup', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          email, 
          password,
          redirect_url: window.location.href // Pass current page URL for redirect after confirmation
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          setCartEmail(email);
          sessionStorage.setItem('authenticated', 'true');
          messageDiv.style.color = '#4CAF50';
          messageDiv.textContent = data.message || 'Account created! Please check your email to confirm your account.';
          // Don't hide the modal immediately - let user know to check email
          setTimeout(() => {
            document.getElementById('email-auth-overlay').style.display = 'none';
            document.getElementById('authenticated-content').style.display = 'block'; // Show authenticated content
          }, 3000); // Give user time to read the message
        } else {
          messageDiv.textContent = data.error || 'Account creation failed. Please try again.';
        }
      })
      .catch(error => {
        console.error('Signup error:', error);
        messageDiv.textContent = 'Account creation failed. Please try again.';
      })
      .finally(() => {
        // Re-enable buttons
        loginBtn.disabled = false;
        signupBtn.disabled = false;
        signupBtn.textContent = 'Create Account';
      });
    }

    function handleForgotPassword() {
      const email = document.getElementById('auth-email').value.trim();
      const messageDiv = document.getElementById('email-auth-message');
      
      if (!email) {
        messageDiv.style.color = '#e53935';
        messageDiv.textContent = 'Please enter your email address first.';
        return;
      }
      
      messageDiv.style.color = '#666';
      messageDiv.textContent = 'Sending password reset email...';
      
      // Call forgot password API
      fetch('/api/auth/forgot-password', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          email: email,
          redirect_url: window.location.href
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          messageDiv.style.color = '#4CAF50';
          messageDiv.textContent = data.message || 'Password reset email sent! Please check your inbox.';
        } else {
          messageDiv.style.color = '#e53935';
          messageDiv.textContent = data.error || 'Failed to send password reset email.';
        }
      })
      .catch(error => {
        console.error('Forgot password error:', error);
        messageDiv.style.color = '#e53935';
        messageDiv.textContent = 'Failed to send password reset email. Please try again.';
      });
    }
    // --- End Email Auth Functions ---
  </script>
</body>
</html> 