<!DOCTYPE html>
<html>
<head>
  <title>🎯 UPDATED v2.0 - Customize Your Product</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🎯</text></svg>">
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; text-align: center; padding: 0; margin: 0; }
    h1 { color: #3f51b5; }
    
    
    
    /* Ensure main container is always visible */
    .main-container {
      display: flex !important;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      gap: 20px;
      min-height: 400px;
      background: #fff;
      border: 2px solid #ccc;
    }
    
         /* Simple Logo Header - Bigger Logo, Less Height */
     .simple-header {
       background: white;
       padding: 5px 2%;
       position: relative;
       z-index: 10;
       border-bottom: 1px solid #eee;
     }

    .simple-header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: flex-start;
      align-items: center;
    }

    .simple-logo {
      display: flex;
      align-items: center;
    }

    .simple-logo .logo-img {
      width: 40px;
      height: 40px;
      display: block;
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .menu-icon {
      width: 24px;
      height: 24px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .menu-icon span {
      width: 100%;
      height: 3px;
      background: #333;
      border-radius: 2px;
    }

    .header-logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-img {
      width: 32px;
      height: 32px;
      display: block;
    }

    .logo-text {
      font-size: 1.2rem;
      font-weight: bold;
      color: #333;
    }

    .search-container {
      flex: 1;
      max-width: 500px;
      margin: 0 20px;
      position: relative;
    }

    .search-input {
      width: 500px;
      padding: 12px 18px;
      border: 1px solid #ccc;
      border-radius: 30px;
      font-size: 16px;
      background: transparent;
      outline: 0;
      transition: border-color 0.2s ease;
    }

    .search-input:focus {
      border-color: #065fd4;
    }

    .search-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      color: #666;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .subscribe-btn {
      background: #cc0000;
      color: white;
      border: 1px solid #cc0000;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.2s ease;
    }

    .subscribe-btn:hover {
      background: #a00000;
      transform: translateY(-1px);
    }

    .signin-btn {
      background: #065fd4;
      color: white;
      border: 1px solid #065fd4;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .signin-btn:hover {
      background: #0448a0;
      transform: translateY(-1px);
    }
    
         /* User Flow Section Styles - Matching Home Page */
     .user-flow-section {
       background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
       margin: 0;
       padding: 40px 20px;
       color: white;
       text-align: center;
       display: flex;
       justify-content: space-between;
       align-items: center;
       position: relative;
       width: 100%;
       box-sizing: border-box;
       min-height: 120px;
     }

    .flow-steps {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: nowrap;
      gap: 12px;
      max-width: 800px;
      margin: 0 auto;
    }

    .flow-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      min-width: 130px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .flow-step:hover {
      transform: translateY(-2px);
    }

                   .step-number {
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        font-weight: bold;
        margin-bottom: 6px;
        transition: all 0.3s ease;
      }

    .flow-step:hover .step-number {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }

                   .step-content h3 {
        margin: 0 0 3px 0;
        font-size: 0.9rem;
        font-weight: 600;
        color: white;
      }

      .step-content p {
        margin: 0;
        font-size: 0.7rem;
        opacity: 0.9;
        line-height: 1.1;
      }

    .flow-arrow {
      font-size: 1.3rem;
      color: rgba(255, 255, 255, 0.7);
      font-weight: bold;
      margin: 0 6px;
    }

         /* Shipping Information */
     .shipping-info {
       display: flex;
       gap: 20px;
       align-items: center;
       margin-top: 0;
       position: absolute;
       top: 10px;
       right: 20px;
       z-index: 5;
     }

    .shipping-item {
      display: flex;
      align-items: center;
      gap: 5px;
      color: white;
      font-size: 0.8rem;
    }

    .shipping-icon {
      font-size: 1rem;
    }

    .shipping-text {
      font-weight: 500;
    }

    /* Main Layout Container */
    .main-container {
      display: flex;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      gap: 20px;
      min-height: 100vh;
    }

         /* Left Column - Two Stacked Windows (Video Preview Removed) */
     .left-column {
       flex: 1;
       min-width: 400px;
       display: flex;
       flex-direction: column;
       gap: 20px;
       max-width: 500px; /* Give more space to products on the right */
       height: 100%; /* Ensure full height */
       position: sticky;
       top: 20px;
       align-self: flex-start;
     }

    /* Screenshots Selected Window */
    .screenshots-selected {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    /* Products Selected Window */
    .products-selected {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      min-height: 150px; /* Ensure minimum height */
      display: flex;
      flex-direction: column;
    }

         /* Right Column - Available Products */
     .products-section {
       flex: 1;
       min-width: 400px;
       background: #fff;
       border-radius: 12px;
       padding: 20px;
       box-shadow: 0 2px 10px rgba(0,0,0,0.1);
     }

     /* Category Navigation Icons */
     .category-navigation {
       margin-bottom: 20px;
       border-bottom: 1px solid #eee;
       padding-bottom: 15px;
     }

     .category-nav-title {
       font-size: 14px;
       font-weight: 600;
       color: #666;
       margin-bottom: 10px;
       text-align: left;
     }

     .category-icons {
       display: flex;
       flex-wrap: wrap;
       gap: 8px;
       justify-content: flex-start;
     }

     .category-icon {
       display: flex;
       flex-direction: column;
       align-items: center;
       padding: 8px 6px;
       border-radius: 8px;
       background: #f8f9fa;
       border: 1px solid #e9ecef;
       cursor: pointer;
       transition: all 0.2s ease;
       min-width: 50px;
       text-decoration: none;
     }

     .category-icon:hover {
       background: #e3f2fd;
       border-color: #2196f3;
       transform: translateY(-1px);
     }

     .category-icon .icon {
       font-size: 18px;
       margin-bottom: 2px;
     }

     .category-icon .label {
       font-size: 10px;
       font-weight: 500;
       color: #666;
       text-align: center;
       line-height: 1.2;
     }

     .category-icon:hover .label {
       color: #2196f3;
     }

    .preview-image {
      max-width: 100%;
      width: 100%;
      height: auto;
      margin-bottom: 10px;
      border-radius: 10px;
      cursor: pointer;
      box-sizing: border-box;
      display: block;
    }
                                                 .screenshot-preview-row { 
        display: flex !important; 
        flex-direction: row !important;
        gap: 6px !important; 
        margin: 6px 0 10px 0 !important;
        min-height: 50px !important; /* Compact height */
        align-items: flex-start !important;
        justify-content: flex-start !important;
      }
      
                 /* Video thumbnail styling - Much smaller size */
               .video-thumbnail {
          width: 60px !important;
          height: 45px !important;
          object-fit: cover !important;
          border-radius: 3px !important;
          border: 2px solid #4CAF50 !important;
          cursor: pointer !important;
          flex-shrink: 0 !important;
        }
    
               /* Screenshot thumbnails container - fits 5 screenshots */
      .screenshot-thumbnails {
        display: grid !important;
        grid-template-columns: repeat(3, 1fr) !important;
        gap: 4px !important;
        flex: 1 !important;
        margin-left: 6px !important;
      }
    
               /* Individual screenshot styling */
      .screenshot-thumbnail {
        width: 100%;
        height: 20px;
        object-fit: cover;
        border-radius: 2px;
        cursor: pointer;
        border: 1px solid #ddd;
        transition: border-color 0.2s;
      }
    
    .screenshot-thumbnail:hover {
      border-color: #4CAF50;
    }
    .screenshot-preview-row img {
      width: 100%;
      height: auto;
      border-radius: 4px;
      border: 2px solid #ccc;
      object-fit: cover;
      cursor: pointer;
      box-sizing: border-box;
    }
    .selected-image {
      border: 4px solid #4CAF50 !important;
      box-shadow: 0 0 8px #4CAF50;
      box-sizing: border-box;
    }
    .product-row { 
      display: grid; 
      grid-template-columns: repeat(3, 1fr); 
      gap: 15px; 
      margin-top: 20px; 
      justify-items: center;
    }
    .product-card { background: #fff; padding: 15px; border-radius: 8px; width: 100%; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #eee; }
    .product-card img { width: 100%; height: auto; border-radius: 6px; margin-bottom: 10px; }
    .product-title { font-weight: bold; margin: 10px 0 5px; font-size: 14px; }
    .product-price { color: #444; margin-bottom: 10px; font-size: 12px; }
    .note-input { width: 100%; padding: 6px; margin-bottom: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; }
    .variant-selector { margin-bottom: 12px; background: #f0f4ff; border: 1px solid #bfcfff; border-radius: 6px; padding: 10px; }
    .variant-selector label { display: block; text-align: left; margin-bottom: 4px; color: #3f51b5; font-weight: bold; font-size: 12px; }
    .variant-selector select { width: 100%; padding: 6px; border: 1.5px solid #3f51b5; border-radius: 4px; background: #fff; font-size: 12px; }
    .btn { background: #3f51b5; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .btn:hover { background: #2c3cb5; }
    
    /* Remove the old cart sidebar */
    #cart-sidebar { 
      display: none;
    }
    
         /* Mobile Responsive */
     @media (max-width: 768px) {
       .main-container {
         flex-direction: column;
         padding: 10px;
         gap: 15px;
       }
       
       .left-column {
         min-width: auto;
         max-width: 100%;
       }
       
       .right-column {
         min-width: auto;
       }
       
       .screenshots-selected,
       .products-selected,
       .products-section {
         padding: 15px;
         margin-bottom: 15px;
       }
       
       .screenshot-preview-row {
         min-height: 100px;
         margin: 8px 0 10px 0;
       }
       
       .video-thumbnail {
         height: 30px;
         margin-bottom: 3px;
       }
       
       .screenshot-thumbnails {
         grid-template-columns: repeat(3, 1fr);
         gap: 6px;
         margin-top: 8px;
       }
       
       .screenshot-thumbnail {
         height: 50px;
       }
       
       .product-row {
         grid-template-columns: 1fr;
         gap: 12px;
         margin-top: 15px;
       }
       
       .product-card {
         padding: 12px;
       }
       
       .product-card img {
         height: 150px;
       }
       
       .variant-selector {
         padding: 8px;
         margin-bottom: 10px;
       }
       
       .variant-selector label {
         font-size: 11px;
       }
       
       .variant-selector select {
         padding: 5px;
         font-size: 11px;
       }
       
       .note-input {
         padding: 5px;
         font-size: 11px;
         margin-bottom: 10px;
       }
       
       .btn {
         padding: 10px 16px;
         font-size: 14px;
         width: 100%;
       }
       
       .user-flow-section {
         padding: 20px 15px;
         min-height: 100px;
         flex-direction: column;
         gap: 15px;
       }
       
       .flow-steps {
         position: static !important;
         transform: none !important;
         left: auto !important;
         margin: 0 auto;
       }
       
       .shipping-info {
         position: static !important;
         top: auto !important;
         right: auto !important;
         justify-content: center;
         flex-wrap: wrap;
         gap: 10px;
         margin-top: 10px;
       }
       
       .shipping-item {
         font-size: 0.7rem;
         gap: 3px;
       }
       
       .shipping-icon {
         font-size: 0.9rem;
       }
       
       .step-number {
         width: 28px;
         height: 28px;
         font-size: 0.9rem;
       }
       
       .step-content h3 {
         font-size: 0.8rem;
       }
       
       .step-content p {
         font-size: 0.6rem;
       }
       
       /* Touch-friendly interactions */
       .screenshot-thumbnail,
       .video-thumbnail,
       .btn,
       .variant-selector select {
         min-height: 44px;
         touch-action: manipulation;
       }
       
       .screenshot-thumbnail:hover,
       .video-thumbnail:hover {
         transform: scale(1.05);
       }
       
       /* Better spacing for mobile */
       h3 {
         font-size: 1.1rem;
         margin-bottom: 10px;
       }
       
       .selected-products {
         min-height: 60px;
         display: flex;
         align-items: center;
         justify-content: center;
       }
     }
     
     /* Extra small mobile devices */
     @media (max-width: 480px) {
       .main-container {
         padding: 8px;
         gap: 12px;
       }
       
       .screenshots-selected,
       .products-selected,
       .products-section {
         padding: 12px;
       }
       
       .screenshot-thumbnails {
         grid-template-columns: repeat(2, 1fr);
         gap: 4px;
       }
       
       .product-card img {
         height: 120px;
       }
       
       .user-flow-section {
         padding: 15px 10px;
       }
       
       .shipping-info {
         gap: 8px;
       }
       
       .shipping-item {
         font-size: 0.6rem;
       }
     }
  </style>
</head>
<body>
  
   

     <!-- User Flow Section - Only Step 3 since we're already at merchandise page -->
   <div class="user-flow-section">
           <!-- Make Merchandise Section - Now positioned above Screenshots Selected -->
      <div class="flow-steps" style="position: absolute; left: 25%; transform: translateX(-50%); z-index: 5;">
        <div class="flow-step">
          <div class="step-number">3</div>
          <div class="step-content">
            <h3>Make Merchandise</h3>
            <p>Create custom products with your screenshot</p>
          </div>
        </div>
      </div>
     
     <!-- Shipping Information - Now on the UPPER RIGHT -->
     <div class="shipping-info">
       <div class="shipping-item">
         <span class="shipping-icon">🌍</span>
         <span class="shipping-text">Global Shipping</span>
       </div>
       <div class="shipping-item">
         <span class="shipping-icon">📦</span>
         <span class="shipping-text">US/Mexico Fulfillment</span>
       </div>
       <div class="shipping-item">
         <span class="shipping-icon">🎨</span>
         <span class="shipping-text">Core Colors Available</span>
       </div>
        <div class="shipping-item">
          <span class="shipping-icon">✅</span>
          <span class="shipping-text">3-14 Day Delivery</span>
        </div>
     </div>
   </div>

  <!-- Main Layout -->
  <div class="main-container">
    <!-- Left Column - Two Stacked Windows (Video Preview Removed) -->
    <div class="left-column">
      <!-- Top Window: Screenshots Selected -->
               <div class="screenshots-selected" id="screenshotsSelected">
           <h3>Screenshots Selected</h3>
           <div class="screenshot-preview-row" id="screenshotPreviewRow">
             <!-- Video thumbnail will be auto-inserted here -->
           </div>
         </div>
      
      <!-- Bottom Window: Products Selected -->
      <div class="products-selected" id="productsSelected">
        <h3>Products Selected</h3>
        <div class="selected-products" id="selectedProducts">
          <p>No products selected yet</p>
        </div>
        
        <!-- Order Summary -->
        <div id="orderSummary" style="display: none; margin-top: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #28a745;">
          <div style="font-weight: bold; color: #333; margin-bottom: 8px;">📋 Order Summary</div>
          <div id="summaryDetails" style="font-size: 13px; color: #666; line-height: 1.4;">
            <div><span id="itemCount">0</span> items • Subtotal: $<span id="subtotal">0.00</span></div>
            <div style="margin-top: 4px;">✅ Shipping calculated at checkout</div>
            <div style="margin-top: 4px; color: #28a745;">💡 <strong>Multiple items = Better shipping rates!</strong></div>
          </div>
        </div>
        
                 <button class="btn checkout-btn" onclick="goToCheckout()" style="margin-top: 15px; width: 100%;">Go to Checkout</button>
      </div>
    </div>

    <!-- Right Column - Available Products -->
    <div class="products-section" id="productsSection">
      {% if show_category_selection %}
      <!-- Category Selection Landing -->
      <div class="category-selection-landing" style="text-align: center; padding: 40px 20px;">
        <h2 style="color: #333; margin-bottom: 10px;">Choose a Product Category</h2>
        <p style="color: #666; margin-bottom: 30px;">Select a category to browse products for your custom merchandise</p>
        
        <div class="category-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; max-width: 600px; margin: 0 auto;">
          <div class="category-card" onclick="switchCategory('womens')" style="cursor: pointer; padding: 20px; background: #f8f9fa; border-radius: 12px; transition: all 0.3s; border: 2px solid transparent;">
            <span style="font-size: 2.5rem; display: block; margin-bottom: 8px;">👩</span>
            <span style="font-weight: 600; color: #333;">Women's</span>
          </div>
          <div class="category-card" onclick="switchCategory('mens')" style="cursor: pointer; padding: 20px; background: #f8f9fa; border-radius: 12px; transition: all 0.3s; border: 2px solid transparent;">
            <span style="font-size: 2.5rem; display: block; margin-bottom: 8px;">👨</span>
            <span style="font-weight: 600; color: #333;">Men's</span>
          </div>
          <div class="category-card" onclick="switchCategory('kids')" style="cursor: pointer; padding: 20px; background: #f8f9fa; border-radius: 12px; transition: all 0.3s; border: 2px solid transparent;">
            <span style="font-size: 2.5rem; display: block; margin-bottom: 8px;">👶</span>
            <span style="font-weight: 600; color: #333;">Kids</span>
          </div>
          <div class="category-card" onclick="switchCategory('mugs')" style="cursor: pointer; padding: 20px; background: #f8f9fa; border-radius: 12px; transition: all 0.3s; border: 2px solid transparent;">
            <span style="font-size: 2.5rem; display: block; margin-bottom: 8px;">☕</span>
            <span style="font-weight: 600; color: #333;">Mugs</span>
          </div>
          <!-- Empty space for alignment -->
          <div></div>
          <div class="category-card" onclick="switchCategory('hats')" style="cursor: pointer; padding: 20px; background: #f8f9fa; border-radius: 12px; transition: all 0.3s; border: 2px solid transparent;">
            <span style="font-size: 2.5rem; display: block; margin-bottom: 8px;">🧢</span>
            <span style="font-weight: 600; color: #333;">Hats</span>
          </div>
          <div class="category-card" onclick="switchCategory('bags')" style="cursor: pointer; padding: 20px; background: #f8f9fa; border-radius: 12px; transition: all 0.3s; border: 2px solid transparent;">
            <span style="font-size: 2.5rem; display: block; margin-bottom: 8px;">👜</span>
            <span style="font-weight: 600; color: #333;">Bags</span>
          </div>
          <!-- Empty space for alignment -->
          <div></div>
        </div>
      </div>
      
      <style>
        .category-card:hover {
          transform: translateY(-4px);
          box-shadow: 0 8px 25px rgba(0,0,0,0.15);
          border-color: #4CAF50 !important;
          background: #fff !important;
        }
      </style>
      {% else %}
      <!-- Category Navigation Icons -->
      <div class="category-navigation">
        <div class="category-nav-title">Shop Other Categories:</div>
        <div class="category-icons">
          <div class="category-icon" onclick="switchCategory('womens')" title="Women's">
            <span class="icon">👩</span>
            <span class="label">Women's</span>
          </div>
          <div class="category-icon" onclick="switchCategory('mens')" title="Men's">
            <span class="icon">👨</span>
            <span class="label">Men's</span>
          </div>
          <div class="category-icon" onclick="switchCategory('kids')" title="Kids">
            <span class="icon">👶</span>
            <span class="label">Kids</span>
          </div>
          <div class="category-icon" onclick="switchCategory('mugs')" title="Mugs">
            <span class="icon">☕</span>
            <span class="label">Mugs</span>
          </div>
          <div class="category-icon" onclick="switchCategory('hats')" title="Hats">
            <span class="icon">🧢</span>
            <span class="label">Hats</span>
          </div>
          <div class="category-icon" onclick="switchCategory('bags')" title="Bags">
            <span class="icon">👜</span>
            <span class="label">Bags</span>
          </div>
          <div class="category-icon" onclick="switchCategory('pets')" title="Pets">
            <span class="icon">🐕</span>
            <span class="label">Pets</span>
          </div>
          <div class="category-icon" onclick="switchCategory('stickers')" title="Stickers">
            <span class="icon">🌟</span>
            <span class="label">Stickers</span>
          </div>
          <div class="category-icon" onclick="switchCategory('misc')" title="Misc">
            <span class="icon">📦</span>
            <span class="label">Misc</span>
          </div>
        </div>
      </div>
      
      <h3>Available Products</h3>
      <div class="product-row" id="productRow"></div>
      {% endif %}
    </div>
  </div>

     <script>
     console.log('🚀 Merchandise page script loaded');
     
     // EMERGENCY FIX: Clear any existing screenshot capture intervals
     if (window.screenshotInterval) {
       clearInterval(window.screenshotInterval);
       console.log('🛑 Cleared existing screenshot interval');
     }
     
     // Clear all intervals to stop screenshot loops
     for (let i = 1; i < 99999; i++) {
       clearInterval(i);
     }
     console.log('🛑 Cleared all intervals to stop screenshot loops');
     
     // Simple initialization
     document.addEventListener('DOMContentLoaded', function() {
       console.log('✅ DOM loaded successfully');
       
       // Load persistent cart from previous sessions
       loadCartFromStorage();
       
       // Get data from backend
       const videoThumbnail = '{{ img_url }}';
       const screenshots = [];
       {% if screenshots %}
         {% for screenshot in screenshots %}
           screenshots.push('{{ screenshot }}');
         {% endfor %}
       {% endif %}
       
       console.log('📸 Video thumbnail:', videoThumbnail);
       console.log('📸 Screenshots:', screenshots);
       
       // Display screenshots
       const row = document.getElementById("screenshotPreviewRow");
       if (row) {
         row.innerHTML = '';
         
                                     // Video thumbnail removed to prevent duplicates
         // The thumbnail is already included in the screenshots array
         
                   // Add screenshots
          const thumbnailsContainer = document.createElement("div");
          thumbnailsContainer.className = "screenshot-thumbnails";
          
          console.log('📸 Processing screenshots:', screenshots);
          
          // Video thumbnail will be automatically selectable from the main preview
          // No need to add it to the small thumbnails container
          
          // Add screenshots
          let screenshotsToShow = screenshots;
          screenshotsToShow.forEach((src, index) => {
            console.log(`📸 Screenshot ${index + 1}:`, src);
            if (src && src !== 'None' && src !== '') {
              const img = document.createElement("img");
              img.src = src;
              img.className = "screenshot-thumbnail";
              img.alt = `Screenshot ${index + 1}`;
              img.addEventListener('click', function() {
                selectScreenshot(img, src);
              });
              thumbnailsContainer.appendChild(img);
              console.log(`✅ Added screenshot ${index + 1}`);
            } else {
              console.log(`⚠️ Skipping screenshot ${index + 1} - invalid source:`, src);
            }
          });
          
          row.appendChild(thumbnailsContainer);
          console.log(`✅ Added ${thumbnailsContainer.children.length} screenshots to container`);
          
          // Add the main video thumbnail as a large clickable preview
          if (videoThumbnail && videoThumbnail !== '' && videoThumbnail !== 'None') {
            const mainThumbnailImg = document.createElement("img");
            mainThumbnailImg.src = videoThumbnail;
            mainThumbnailImg.alt = "Video Thumbnail - Click to select";
            mainThumbnailImg.style.cssText = "width: 200px; height: 150px; object-fit: cover; border: 3px solid #ccc; cursor: pointer; border-radius: 8px; margin-top: 10px; transition: border-color 0.3s;";
            mainThumbnailImg.addEventListener('click', function() {
              selectScreenshot(mainThumbnailImg, videoThumbnail);
            });
            row.appendChild(mainThumbnailImg);
            console.log('✅ Added main video thumbnail as clickable preview');
          }
       }
       
               // Display products
        const productRow = document.getElementById("productRow");
        if (productRow) {
          // Get products from backend
          window.products = []; // Make products global
          {% if products %}
            {% for product in products %}
              window.products.push({
                name: '{{ product.name }}',
                price: {{ product.price }},
                main_image: '{{ product.main_image }}',
                filename: '{{ product.filename }}',
                preview_image: '{{ product.preview_image }}',
                options: {{ product.options | tojson }},
                size_pricing: {{ (product.size_pricing | tojson) if (product.size_pricing is defined) else 'null' }}
              });
            {% endfor %}
          {% endif %}
          
          console.log('🛍️ Products to display:', window.products.length);
          
                     if (window.products.length > 0) {
             productRow.innerHTML = ''; // Clear existing content
             
             // Only show first 30 products to avoid duplicates
             const productsToShow = window.products.slice(0, 30);
             
             productsToShow.forEach((product, index) => {
              const productCard = document.createElement("div");
              productCard.className = "product-card";
                             productCard.innerHTML = `
                 <!-- Top Image (Blank Product) -->
                 <img src="/static/images/${product.filename}" alt="${product.name} - Blank" style="width:100%;height:150px;object-fit:cover;border-radius:6px;margin-bottom:8px;">
                 
                 <!-- Bottom Image (Preview with Design) -->
                 <img src="/static/images/${product.preview_image || product.filename}" alt="${product.name} - Preview" style="width:100%;height:150px;object-fit:cover;border-radius:6px;">
                 
                 <div class="product-title">${product.name}</div>
                 <div class="product-price" id="price-${index}">$${product.price.toFixed(2)}</div>
                 ${product.options.color ? `
                   <div class="variant-selector">
                     <label>Color:</label>
                     <select class="variant-select color-select">
                       ${product.options.color.map(color => `<option value="${color}">${color}</option>`).join('')}
                     </select>
                   </div>
                 ` : ''}
                 ${product.options.size ? `
                   <div class="variant-selector">
                     <label>Size:</label>
                     <select class="variant-select size-select" onchange="updatePrice(${index}, '${product.name}', this.value)">
                       ${product.options.size.map(size => `<option value="${size}">${size}</option>`).join('')}
                     </select>
                   </div>
                 ` : ''}
                 <hr style="margin: 8px 0; border: none; border-top: 1px solid #eee;">
                 <button class="btn add-to-cart-btn" onclick="addToCart('${product.name}', ${product.price}, this)">Add ${product.name} to Cart</button>
               `;
                             productRow.appendChild(productCard);
             });
             
             console.log(`✅ Added ${productsToShow.length} product cards (showing first 30)`);
             
             // Add event listeners to all size dropdowns
             setTimeout(() => {
               const sizeDropdowns = document.querySelectorAll('.size-select');
               console.log(`🔍 Found ${sizeDropdowns.length} size dropdowns`);
               sizeDropdowns.forEach((dropdown, index) => {
                 console.log(`🔍 Adding event listener to dropdown ${index}`);
                 dropdown.addEventListener('change', function() {
                   console.log(`🔄 Dropdown ${index} changed to: ${this.value}`);
                   const productIndex = index;
                   const productName = window.products[index].name;
                   updatePrice(productIndex, productName, this.value);
                 });
               });
             }, 100);
          } else {
            productRow.innerHTML = '<p style="text-align:center; color:#666; padding:20px;">No products available at the moment.</p>';
            console.log('⚠️ No products to display');
          }
        }
       
                        console.log('✅ Merchandise page initialized');
         
         // Test function to manually trigger price update
         window.testPriceUpdate = function() {
           console.log('🧪 Testing price update...');
           if (window.products && window.products.length > 0) {
             updatePrice(0, window.products[0].name, 'XXXXXL');
           }
         };
         
         // Test if updatePrice function is accessible
         console.log('🔍 Testing if updatePrice function exists:', typeof updatePrice);
         console.log('🔍 Testing if window.products exists:', typeof window.products);
         if (window.products && window.products.length > 0) {
           console.log('🔍 First product:', window.products[0]);
         }
       });
      
             // Screenshot selection functionality
       let selectedScreenshotUrl = null;
       
       function selectScreenshot(imgElement, screenshotUrl) {
         // Remove selection from all screenshots
         document.querySelectorAll('.screenshot-thumbnail, .video-thumbnail').forEach(img => {
           img.classList.remove('selected-image');
         });
         
         // Add selection to clicked image
         imgElement.classList.add('selected-image');
         selectedScreenshotUrl = screenshotUrl;
         
         console.log(`🎯 Selected screenshot: ${screenshotUrl}`);
         
         // Update all product cards to show selected image
         updateProductImages(screenshotUrl);
       }
       
               function updateProductImages(selectedImageUrl) {
          // Don't update product images - just show selection
          console.log('🎯 Screenshot selected for preview only');
        }

        // Simplified category switching function - just reload with new category filter
        function switchCategory(category) {
          console.log('🔄 Switching to category:', category);
          
          // Show loading feedback
          const categoryIcons = document.querySelectorAll('.category-icon');
          categoryIcons.forEach(icon => {
            icon.style.pointerEvents = 'none';
            icon.style.opacity = '0.6';
          });
          
          // Simple approach: reload current page with category parameter
          const currentUrl = new URL(window.location.href);
          currentUrl.searchParams.set('category', category);
          
          // Redirect to same page with category filter
          window.location.href = currentUrl.toString();
        }
       
               // Dynamic pricing function
        function updatePrice(productIndex, productName, selectedSize) {
          console.log(`🔄 updatePrice called: productIndex=${productIndex}, productName=${productName}, selectedSize=${selectedSize}`);
          
          const priceElement = document.getElementById(`price-${productIndex}`);
          if (!priceElement) {
            console.log(`❌ Price element not found for index ${productIndex}`);
            return;
          }
          
          // Default size pricing adjustments (fallback)
          const defaultSizeAdjustments = { "XS": 0, "S": 0, "M": 0, "L": 0, "XL": 2, "XXL": 3, "XXXL": 4, "XXXXL": 5, "XXXXXL": 8 };
          
          console.log(`📊 Available products:`, window.products);
          
          // Find base price from products array
          const product = window.products.find(p => p.name === productName);
          if (!product) {
            console.log(`❌ Product not found: ${productName}`);
            return;
          }
          
          const basePrice = product.price;
          const sizeAdjustments = product.size_pricing || defaultSizeAdjustments;
          const adjustment = sizeAdjustments[selectedSize] || 0;
          const newPrice = basePrice + adjustment;
          
          console.log(`💰 Price calculation: basePrice=${basePrice}, adjustment=${adjustment}, newPrice=${newPrice}`);
          
          priceElement.textContent = `$${newPrice.toFixed(2)}`;
          
          // Update the button price for cart
          const card = priceElement.closest('.product-card');
          const addButton = card.querySelector('.add-to-cart-btn');
          if (addButton) {
            addButton.setAttribute('data-price', newPrice);
            console.log(`✅ Updated button data-price to ${newPrice}`);
          }
          
          console.log(`✅ Price updated to $${newPrice.toFixed(2)}`);
        }
       
       // Cart persistence functions
       function saveCartToStorage() {
         const selectedProducts = document.getElementById('selectedProducts');
         const cartItems = [];
         
         // Get all cart items
         const productItems = selectedProducts.querySelectorAll('.cart-product-item');
         productItems.forEach(item => {
           const img = item.querySelector('img');
           const nameDiv = item.querySelector('div div:first-child');
           const detailsDiv = item.querySelector('div div:last-child');
           
           if (img && nameDiv && detailsDiv) {
             cartItems.push({
               screenshot: img.src,
               name: nameDiv.textContent,
               details: detailsDiv.innerHTML,
               fullHTML: item.outerHTML
             });
           }
         });
         
         // Save to localStorage
         localStorage.setItem('persistent_cart', JSON.stringify(cartItems));
         console.log(`💾 Saved ${cartItems.length} items to cart storage`);
       }
       
       function loadCartFromStorage() {
         try {
           const savedCart = localStorage.getItem('persistent_cart');
           if (!savedCart) return;
           
           const cartItems = JSON.parse(savedCart);
           const selectedProducts = document.getElementById('selectedProducts');
           
           if (cartItems.length > 0) {
             // Clear existing content
             selectedProducts.innerHTML = '';
             
             // Add saved items
             cartItems.forEach(item => {
               selectedProducts.insertAdjacentHTML('beforeend', item.fullHTML);
             });
             
             console.log(`🔄 Loaded ${cartItems.length} items from cart storage`);
             
             // Update order summary after loading
             updateOrderSummary();
           }
         } catch (error) {
           console.error('Error loading cart from storage:', error);
         }
       }
       
       function updateOrderSummary() {
         const selectedProducts = document.getElementById('selectedProducts');
         const orderSummary = document.getElementById('orderSummary');
         const itemCountElement = document.getElementById('itemCount');
         const subtotalElement = document.getElementById('subtotal');
         
         // Count items and calculate subtotal
         const productItems = selectedProducts.querySelectorAll('.cart-product-item');
         const itemCount = productItems.length;
         
         let subtotal = 0;
         productItems.forEach(item => {
           const detailsElement = item.querySelector('div div:last-child');
           if (detailsElement) {
             const details = detailsElement.innerHTML;
             const priceMatch = details.match(/\$(\d+\.\d+)/);
             if (priceMatch) {
               subtotal += parseFloat(priceMatch[1]);
             }
           }
         });
         
         // Show/hide summary based on item count
         if (itemCount > 0) {
           orderSummary.style.display = 'block';
           itemCountElement.textContent = itemCount;
           subtotalElement.textContent = subtotal.toFixed(2);
         } else {
           orderSummary.style.display = 'none';
         }
       }
       

       
       // Add to cart functionality
              function addToCart(productName, price, button) {
                // Get the current price from the button's data attribute or use the passed price
                const currentPrice = parseFloat(button.getAttribute('data-price')) || price;
         const card = button.closest('.product-card');
         const colorSelect = card.querySelector('.color-select');
         const sizeSelect = card.querySelector('.size-select');
         const noteInput = card.querySelector('.note-input');
         
         const selectedColor = colorSelect ? colorSelect.value : 'Default';
         const selectedSize = sizeSelect ? sizeSelect.value : 'Default';
         const note = noteInput ? noteInput.value : '';
         
         const selectedProducts = document.getElementById('selectedProducts');
         
         // Check if user has selected a screenshot
         const hasScreenshot = selectedScreenshotUrl !== null;
         
         if (!hasScreenshot) {
           alert('Please choose Thumbnail or Screenshot');
           return;
         }
         
         // Get the selected screenshot URL
         const selectedScreenshot = selectedScreenshotUrl;
         
                   // Create product item with image
          const productItem = document.createElement('div');
          productItem.className = 'cart-product-item';
          productItem.style.cssText = 'background:#f8f9fa; padding:10px; margin:5px 0; border-radius:6px; border-left:4px solid #3f51b5; display:flex; gap:10px; align-items:center;';
          productItem.innerHTML = `
            <img src="${selectedScreenshot}" alt="Selected Image" style="width:60px; height:60px; object-fit:cover; border-radius:4px; border:2px solid #4CAF50;">
            <div style="flex:1;">
              <div style="font-weight:bold; color:#333;">${productName}</div>
              <div style="color:#666; font-size:12px;">
                Color: ${selectedColor} | Size: ${selectedSize} | $${currentPrice.toFixed(2)}
                ${note ? `<br>Note: ${note}` : ''}
              </div>
            </div>
            <button onclick="removeFromCart(this)" style="background:#dc3545; color:white; border:none; padding:2px 8px; border-radius:3px; font-size:10px; margin-top:5px;">Remove</button>
          `;
        
        selectedProducts.appendChild(productItem);
        
        // Update the "No products selected yet" message
        const noProductsMsg = selectedProducts.querySelector('p');
        if (noProductsMsg) {
          noProductsMsg.remove();
        }
        
        // Save cart to localStorage for persistence across category switches
        saveCartToStorage();
        
        // Update order summary
        updateOrderSummary();
        
        // Change button text temporarily
        button.textContent = 'Added to Cart';
        button.style.background = '#28a745';
        
        // Reset button after 2 seconds to allow re-adding with different images
        setTimeout(() => {
          button.textContent = `Add ${productName} to Cart`;
          button.style.background = '#4CAF50';
        }, 2000);
        
        console.log(`🛒 Added to cart: ${productName} - ${selectedColor} ${selectedSize} - $${currentPrice.toFixed(2)}`);
      }
      
      function removeFromCart(button) {
        button.parentElement.remove();
        
        // If no products left, show the message again
        const selectedProducts = document.getElementById('selectedProducts');
        if (selectedProducts.children.length === 0) {
          selectedProducts.innerHTML = '<p>No products selected yet</p>';
        }
        
        // Save updated cart to localStorage
        saveCartToStorage();
        
        // Update order summary
        updateOrderSummary();
      }
      
                   function goToCheckout() {
        console.log('🛒 goToCheckout function called');
        
        const selectedProducts = document.getElementById('selectedProducts');
        console.log('🛒 selectedProducts element:', selectedProducts);
        console.log('🛒 selectedProducts children length:', selectedProducts ? selectedProducts.children.length : 'element not found');
        
        if (!selectedProducts) {
          alert('Error: Could not find selected products container');
          return;
        }
        
        if (selectedProducts.children.length === 0) {
          alert('Please add some products to your cart first!');
          return;
        }
        
                 // Collect all selected products for checkout
         const products = [];
         console.log('🛒 Collecting products from DOM...');
         
                   // Only select the direct product item divs using the specific class
          const productItems = selectedProducts.querySelectorAll('.cart-product-item');
          console.log(`🛒 Found ${productItems.length} product items`);
         
         productItems.forEach((item, index) => {
           console.log(`🛒 Processing item ${index + 1}:`, item);
           
           const nameElement = item.querySelector('div');
           const detailsElement = item.querySelector('div:nth-child(2)');
           const imageElement = item.querySelector('img');
           
           console.log(`🛒 Name element:`, nameElement);
           console.log(`🛒 Details element:`, detailsElement);
           console.log(`🛒 Image element:`, imageElement);
           
           if (nameElement && detailsElement) {
             const productName = nameElement.textContent;
             const details = detailsElement.textContent;
             const image = imageElement ? imageElement.src : '';
             
             // Extract price from details text (format: "Color: X | Size: Y | $Z.ZZ")
             let price = 24.99; // Default price
             const priceMatch = details.match(/\$(\d+\.\d+)/);
             if (priceMatch) {
               price = parseFloat(priceMatch[1]);
             }
             
             // Extract color and size from details
             let color = 'Default';
             let size = 'Default';
             const colorMatch = details.match(/Color:\s*([^|]+)/);
             const sizeMatch = details.match(/Size:\s*([^|]+)/);
             if (colorMatch) color = colorMatch[1].trim();
             if (sizeMatch) size = sizeMatch[1].trim();
             
             console.log(`🛒 Adding product: ${productName} - ${details} - Price: $${price}`);
             
             products.push({
               name: productName,
               details: details,
               image: image,
               price: price,
               variants: {
                 color: color,
                 size: size
               },
               video_title: '{{ video_title }}',
               creator_name: '{{ creator_name }}'
             });
           } else {
             console.log(`🛒 Skipping item ${index + 1} - missing name or details`);
           }
         });
        
        console.log('🛒 Proceeding to checkout with:', products);
        
        // Redirect to checkout page with product data
        const productId = '{{ product_id }}';
        
        // Get authentication state from URL parameters (passed from frontend)
        const urlParams = new URLSearchParams(window.location.search);
        const isAuthenticated = urlParams.get('authenticated') || localStorage.getItem('user_authenticated');
        const userEmail = urlParams.get('email') || localStorage.getItem('user_email');
        
        console.log('🔐 Authentication check - isAuthenticated:', isAuthenticated);
        console.log('🔐 Authentication check - userEmail:', userEmail);
        
        // Build checkout URL with authentication parameters
        let checkoutUrl = `/checkout/${productId}`;
        if (isAuthenticated && userEmail) {
          checkoutUrl += `?authenticated=true&email=${encodeURIComponent(userEmail)}`;
        }
        
        console.log('🛒 Redirecting to:', checkoutUrl);
        
        // Store cart data in sessionStorage for checkout page
        sessionStorage.setItem('cartData', JSON.stringify(products));
        
        // Redirect to checkout
        window.location.href = checkoutUrl;
      }
    </script>
</body>
</html>